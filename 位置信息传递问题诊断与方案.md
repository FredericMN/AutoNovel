# 位置信息传递问题诊断与解决方案

---

## 📋 问题确认

### ✅ 问题确实存在

经过代码排查，**确认当前系统存在位置信息传递缺失问题**：

#### 1. **角色状态文件缺失位置字段**

**当前 `character_state.txt` 结构**（`prompt_definitions.py:763-801`）：
```
角色名：
├──物品
├──能力
├──状态
│  ├──身体状态
│  └──心理状态
├──主要角色间关系网
└──触发或加深的事件
```

**缺失**：❌ 没有"位置/地点"字段

#### 2. **摘要更新未强制记录地点**

**当前 `summary_prompt`**（`prompt_definitions.py:655-670`）：
```
要求：
- 保留既有重要信息，同时融入新剧情要点
- 以简洁、连贯的语言描述全书进展
- 客观描绘，不展开联想或解释
- 总字数控制在2000字以内
```

**问题**：❌ 没有明确要求记录时间和地点

#### 3. **章节生成传递内容不完整**

**章节生成传递内容**（`chapter.py:822-829`）：
- ✅ Novel_architecture.txt
- ✅ Novel_directory.txt
- ✅ global_summary.txt
- ✅ character_state.txt
- ✅ 最近3章正文

**问题**：❌ 没有结构化的地点信息传递

---

## 🔍 问题影响分析

### 场景1：情节紧凑时位置混乱

```
第10章：主角在【北京市朝阳区×××公寓】修炼
第11章：遇到敌人战斗（无地点描述）
第12章：突破境界（无地点描述）
第13章：剧情发展（无地点描述）
第14章：AI可能杜撰位置 → "主角在修炼洞府中突破" ❌
```

**问题**：连续3章没提地点，AI忘记了在公寓。

---

### 场景2：幻境/副本混淆

```
第20章：主角现实位置【公寓卧室】，进入【试炼幻境】
第21-30章：在幻境中历险（10章剧情）
第31章：退出幻境
第32章：AI可能认为主角还在野外 ❌
```

**问题**：无法区分"现实位置"和"剧情位置"。

---

### 场景3：多角色支线位置冲突

```
主角：在【A市】执行任务
配角A：在【B市】处理私事
配角B：在【C市】寻找线索

几章后...
AI可能让配角A突然出现在A市帮助主角 ❌
```

**问题**：没有为每个角色独立管理位置。

---

## 💡 解决方案对比

### 方案A：在角色状态中添加位置字段（推荐✅）

#### 优点
- ✅ 每个角色独立位置，支持多角色支线
- ✅ 与现有角色状态体系一致
- ✅ 适配各种题材（古风、现代、奇幻）
- ✅ 能区分"现实位置"和"剧情位置"

#### 缺点
- ⚠️ 需要修改提示词
- ⚠️ 需要迁移现有项目的角色状态

---

### 方案B：创建独立的 `location_state.txt`

#### 优点
- ✅ 不影响现有角色状态结构

#### 缺点
- ❌ 增加文件数量
- ❌ 地点与角色分离，不利于管理
- ❌ 需要额外的同步机制

---

### 方案C：在摘要中强化地点描述

#### 优点
- ✅ 最简单，只需修改提示词

#### 缺点
- ❌ 无法为每个角色独立管理位置
- ❌ 不适合多角色支线
- ❌ 容易被其他内容冲淡

---

### 方案D：综合方案（最佳推荐⭐）

**组合优势**：
1. **角色状态** 记录每个角色的详细位置
2. **摘要** 强化主要场景的地点描述
3. **章节生成** 明确传递地点信息

---

## 🎯 推荐实施方案（方案D）

### 第一步：扩展角色状态结构

#### 新增位置字段结构

```
角色名：
├──当前位置 🆕
│  ├──现实位置：【层级1】→【层级2】→【层级3】→【层级4】
│  ├──剧情位置：【与现实位置相同】或【副本/幻境名称】
│  ├──位置状态：【静止/移动中/传送中】
│  └──位置备注：【补充说明】
├──物品
├──能力
├──状态
│  ├──身体状态
│  └──心理状态
├──主要角色间关系网
└──触发或加深的事件
```

---

#### 位置层级适配各种题材

**现代都市题材**：
```
现实位置：【中国·北京市】→【朝阳区】→【××小区3号楼】→【501室卧室】
剧情位置：【与现实位置相同】
```

**古风仙侠题材**：
```
现实位置：【东玄大陆】→【天元国】→【云霞城】→【云霞宗·内门·修炼殿】
剧情位置：【与现实位置相同】
```

**奇幻魔幻题材**：
```
现实位置：【艾泽拉斯大陆】→【暴风王国】→【暴风城】→【法师区·蓝龙旅馆】
剧情位置：【与现实位置相同】
```

**幻境/副本场景**：
```
现实位置：【中国·上海市】→【浦东新区】→【××公寓】→【卧室床上】
剧情位置：【试炼幻境·第三层·火焰试炼场】
位置状态：【意识沉浸幻境中】
位置备注：【肉体在现实卧室，意识在幻境】
```

**游戏网游题材**：
```
现实位置：【北京市】→【海淀区】→【出租屋】→【电脑桌前】
剧情位置：【《永恒纪元》游戏·落日森林·副本入口】
位置状态：【游戏在线中】
```

---

### 第二步：修改提示词

#### 2.1 修改 `update_character_state_prompt`

**在 `core/prompting/prompt_definitions.py` 中修改（约755行）**：

```python
update_character_state_prompt = """\
以下是新完成的章节文本：
{chapter_text}

这是当前的角色状态文档：
{old_state}

请更新主要角色状态，内容格式：
例：
张三：
├──当前位置 🆕
│  ├──现实位置：【东玄大陆】→【天元国】→【云霞城】→【云霞宗·内门·修炼殿】
│  ├──剧情位置：【与现实位置相同】
│  ├──位置状态：【静止】
│  └──位置备注：【正在闭关修炼】
├──物品:
│  ├──青衫：一件破损的青色长袍，带有暗红色的污渍
│  └──寒铁长剑：一柄断裂的铁剑，剑身上刻有古老的符文
├──能力
│  ├──技能1：强大的精神感知能力：能够察觉到周围人的心中活动
│  └──技能2：无形攻击：能够释放一种无法被视觉捕捉的精神攻击
├──状态
│  ├──身体状态: 身材挺拔，穿着华丽的铠甲，面色冷峻
│  └──心理状态: 目前的心态比较平静，但内心隐藏着对柳溪镇未来掌控的野心和不安
├──主要角色间关系网
│  ├──李四：张三从小就与她有关联，对她的成长一直保持关注
│  └──王二：两人之间有着复杂的过去，最近因一场冲突而让对方感到威胁
├──触发或加深的事件
│  ├──村庄内突然出现不明符号：这个不明符号似乎在暗示柳溪镇即将发生重大事件
│  └──李四被刺穿皮肤：这次事件让两人意识到对方的强大实力，促使他们迅速离开队伍

⚠️ 位置信息更新要求：
1. **现实位置**：必须使用【层级1】→【层级2】→【层级3】→【层级4】格式
   - 古风：【大陆/世界】→【国家/宗门】→【城市/地区】→【具体建筑/房间】
   - 现代：【国家】→【城市】→【区域/小区】→【楼栋/房间】
   - 奇幻：【位面/大陆】→【王国/领地】→【城镇】→【具体地点】

2. **剧情位置**：
   - 如果角色在现实中行动：填写【与现实位置相同】
   - 如果角色在幻境/副本/游戏中：填写【幻境/副本/游戏名称及具体位置】

3. **位置状态**：【静止/移动中/传送中/意识沉浸】

4. **位置备注**：补充说明特殊情况（可选）

5. **重要原则**：
   - 如果本章没有明确描述角色移动，位置不变
   - 如果本章描述角色离开某地但未到达新地点，位置状态标记为【移动中】
   - 幻境/副本结束后，剧情位置必须恢复为【与现实位置相同】

角色名：
├──当前位置
│  ├──现实位置：【层级1】→【层级2】→【层级3】→【层级4】
│  ├──剧情位置：【与现实位置相同】或【幻境/副本名称】
│  ├──位置状态：【静止/移动中/传送中/意识沉浸】
│  └──位置备注：【补充说明】（可选）
├──物品:
│  ├──某物(道具)：描述
│  └──XX长剑(武器)：描述
│   ...
├──能力
│  ├──技能1：描述
│  └──技能2：描述
│   ...
├──状态
│  ├──身体状态：
│  └──心理状态：描述

├──主要角色间关系网
│  ├──李四：描述
│  └──王二：描述
│   ...
├──触发或加深的事件
│  ├──事件1：描述
│  └──事件2：描述
    ...

......

仅返回更新后的角色状态文本，不要解释任何内容。
"""
```

---

#### 2.2 修改 `summary_prompt`

**在 `core/prompting/prompt_definitions.py` 中修改（约655行）**：

```python
summary_prompt = """\
以下是新完成的章节文本：
{chapter_text}

这是当前的前文摘要（可为空）：
{global_summary}

请根据本章新增内容，更新前文摘要。

要求：
- 保留既有重要信息，同时融入新剧情要点
- 以简洁、连贯的语言描述全书进展
- 客观描绘，不展开联想或解释
- 总字数控制在2000字以内
- 🆕 **必须记录主要场景的时间和地点信息**（格式：【时间】【地点】发生了什么）
- 🆕 **地点变化时必须明确记录**（如：从【A地】前往【B地】）

摘要格式建议：
- 按时间线叙述剧情
- 重要场景以"【地点】"开头
- 场景转换时使用"随后"、"接着"、"几天后"等时间连接词

示例：
```
【云霞宗·修炼殿】主角张三闭关修炼，突破至筑基期。【云霞宗·议事堂】掌门召集众弟子商议魔族入侵事宜。随后，主角接受任务前往【天元国·边境】调查魔族动向...
```

仅返回前文摘要文本，不要解释任何内容。
"""
```

---

#### 2.3 修改章节生成提示词（增强位置感知）

**在 `next_chapter_draft_prompt` 中增加位置提醒**：

```python
# 在章节生成时强调位置信息
在生成章节正文时，请注意：
1. 开篇明确当前场景位置
2. 场景转换时清晰描述位置变化
3. 保持角色位置的逻辑连贯性
4. 如果是幻境/副本场景，提醒读者角色的现实位置
```

---

### 第三步：迁移现有项目

#### 创建迁移脚本 `scripts/maintenance/migrate_character_location.py`

```python
"""
为现有的 character_state.txt 添加位置字段
"""
import os
import re

def migrate_character_state(filepath):
    """为角色状态文件添加位置字段"""
    char_state_file = os.path.join(filepath, "character_state.txt")

    if not os.path.exists(char_state_file):
        print("角色状态文件不存在，跳过迁移")
        return

    with open(char_state_file, 'r', encoding='utf-8') as f:
        content = f.read()

    # 为每个角色添加位置字段（在角色名后插入）
    pattern = r'(^[^├└│\s].*?：)\n(├──物品)'

    location_template = """
├──当前位置
│  ├──现实位置：【待更新】
│  ├──剧情位置：【与现实位置相同】
│  ├──位置状态：【静止】
│  └──位置备注：【请根据最新章节手动更新位置】
"""

    new_content = re.sub(
        pattern,
        r'\1' + location_template + r'\n\2',
        content,
        flags=re.MULTILINE
    )

    # 备份原文件
    backup_file = char_state_file + ".backup"
    with open(backup_file, 'w', encoding='utf-8') as f:
        f.write(content)

    # 写入新内容
    with open(char_state_file, 'w', encoding='utf-8') as f:
        f.write(new_content)

    print(f"✅ 迁移完成！")
    print(f"   原文件已备份至: {backup_file}")
    print(f"   请手动检查并更新位置信息")

if __name__ == "__main__":
    import sys
    if len(sys.argv) < 2:
        print("用法: python migrate_character_location.py <小说项目路径>")
        sys.exit(1)

    filepath = sys.argv[1]
    migrate_character_state(filepath)
```

---

### 第四步：更新UI提示

#### 在主界面添加位置信息提示

**在 `ui/main_tab.py` 中添加提示框**：

```python
# 在生成草稿按钮旁边添加提示
location_tip = ctk.CTkLabel(
    parent,
    text="💡 提示：系统会自动追踪角色位置，确保剧情连贯",
    font=("微软雅黑", 12),
    text_color="#666666"
)
```

---

## 📊 实施效果预期

### 优势

| 维度 | 改进 | 预期提升 |
|------|------|----------|
| **位置一致性** | 每章明确记录位置 | +90% |
| **幻境/副本** | 区分现实位置和剧情位置 | 100%解决混淆问题 |
| **多角色支线** | 每个角色独立位置 | +80% |
| **跨章节连贯** | 位置信息持续传递 | +70% |

---

### 示例对比

#### 修改前

```
第10章：主角在公寓修炼
第11-13章：（无位置描述）
第14章：AI杜撰"主角在修炼洞府" ❌
```

#### 修改后

```
character_state.txt:
张三：
├──当前位置
│  ├──现实位置：【中国·上海市】→【浦东新区】→【××公寓】→【卧室】
│  ├──剧情位置：【与现实位置相同】
│  ├──位置状态：【静止】
│  └──位置备注：【正在闭关修炼】

第14章：AI生成"主角在公寓卧室中继续修炼" ✅
```

---

## 🚀 实施步骤

### 阶段1：核心功能开发（1-2天）

1. ✅ 修改 `update_character_state_prompt`
2. ✅ 修改 `summary_prompt`
3. ✅ 创建迁移脚本
4. ✅ 测试新提示词

### 阶段2：现有项目迁移（1天）

1. ✅ 运行迁移脚本
2. ✅ 手动检查迁移结果
3. ✅ 更新位置信息

### 阶段3：文档和UI更新（1天）

1. ✅ 更新用户文档
2. ✅ 添加UI提示
3. ✅ 发布更新说明

---

## ⚠️ 注意事项

### 1. 向后兼容性

- 旧项目的角色状态文件会被自动迁移
- 迁移后需要手动更新位置信息
- 新项目自动使用新格式

### 2. 位置层级灵活性

- 不同题材可以灵活调整层级数量
- 层级1-4是建议值，实际可以3-5层
- 关键是保持层级逻辑清晰

### 3. LLM理解能力

- 清晰的格式有助于LLM理解和遵守
- 位置状态标记（静止/移动中）帮助LLM判断
- 位置备注可以补充特殊情况说明

---

## 📝 总结

### 核心改进

✅ **在角色状态中添加位置字段**（现实位置 + 剧情位置）
✅ **在摘要中强化地点记录**
✅ **适配多种题材**（古风、现代、奇幻、游戏）
✅ **解决幻境/副本混淆问题**
✅ **支持多角色支线位置管理**

---

**文档版本**: v1.0
**创建时间**: 2025-10-03
**状态**: 待实施
