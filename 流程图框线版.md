# AutoNovel 流程图

> 使用框线图展示完整流程关系

---

## 📌 整体流程

```
┌─────────┐      ┌─────────┐      ┌─────────┐      ┌─────────┐
│ 步骤1   │ ───→ │ 步骤2   │ ───→ │ 步骤3   │ ───→ │ 步骤4   │
│ 生成架构│      │ 生成目录│      │ 写草稿  │      │ 定稿    │
└─────────┘      └─────────┘      └─────────┘      └─────────┘
     │                │                │                │
     ↓                ↓                ↓                ↓
架构文件          目录文件          章节文件      摘要+向量库
```

---

## 🔄 详细四步流程

### 步骤1：生成架构

```
┌─────────────────────────────────────────────────┐
│                 用户输入                         │
│  • 主题：修仙、科幻、悬疑...                     │
│  • 类型：爽文、权谋、探险...                     │
│  • 章节数：50 / 100 / 200                       │
└────────────────┬────────────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────────────┐
│              AI生成（5次调用）                   │
│  1. 核心设定                                    │
│  2. 世界观                                      │
│  3. 角色关系                                    │
│  4. 剧情架构                                    │
│  5. 初始角色状态                                │
└────────────────┬────────────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────────────┐
│                输出文件                          │
│  📄 Novel_architecture.txt                      │
│  📄 character_state.txt                         │
└─────────────────────────────────────────────────┘
                 │
                 ↓（分卷模式）
┌─────────────────────────────────────────────────┐
│              AI生成分卷架构                      │
│  • 第1卷（1-30章）                              │
│  • 第2卷（31-70章）                             │
│  • 第3卷（71-100章）                            │
└────────────────┬────────────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────────────┐
│  📄 Volume_architecture.txt                     │
└─────────────────────────────────────────────────┘
```

---

### 步骤2：生成目录

```
┌─────────────────────────────────────────────────┐
│               读取架构文件                       │
│  📖 Novel_architecture.txt                      │
│  📖 Volume_architecture.txt（分卷模式）         │
└────────────────┬────────────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────────────┐
│             计算分块大小                         │
│  chunk_size = (max_tokens / 200 / 10) × 10 - 10│
└────────────────┬────────────────────────────────┘
                 │
                 ↓
         ┌───────┴───────┐
         │               │
         ↓               ↓
┌─────────────┐   ┌─────────────┐
│ 一次性生成  │   │ 分块生成    │
│ (章节少)    │   │ (章节多)    │
└──────┬──────┘   └──────┬──────┘
       │                 │
       │                 ↓
       │          ┌─────────────┐
       │          │ 循环生成    │
       │          │ 每批30-50章 │
       │          └──────┬──────┘
       │                 │
       └────────┬────────┘
                ↓
┌─────────────────────────────────────────────────┐
│              输出文件                            │
│  📄 Novel_directory.txt                         │
│     第1章 标题 + 大纲                           │
│     第2章 标题 + 大纲                           │
│     ...                                         │
│     第100章 标题 + 大纲                         │
└─────────────────────────────────────────────────┘
```

---

### 步骤3：生成草稿

```
┌─────────────────────────────────────────────────┐
│              开始写第N章                         │
└────────────────┬────────────────────────────────┘
                 │
                 ↓
         ┌───────┴───────┐
         │ 是第1章？     │
         └───────┬───────┘
           是 ↓     ↓ 否
              │     │
    ┌─────────┘     └─────────┐
    │                         │
    ↓                         ↓
┌─────────┐           ┌─────────────────┐
│ 读取架构│           │ 读取架构        │
└────┬────┘           │ + 前文摘要      │
     │                │ + 角色状态      │
     │                │ + 最近3章       │
     │                └────┬────────────┘
     │                     │
     │                     ↓
     │              ┌─────────────────┐
     │              │  向量检索       │
     │              │  历史相关剧情   │
     │              └────┬────────────┘
     │                   │
     └──────────┬────────┘
                ↓
┌─────────────────────────────────────────────────┐
│               AI生成章节                         │
└────────────────┬────────────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────────────┐
│              输出文件                            │
│  📄 chapter_N.txt   (正文)                      │
│  📄 outline_N.txt   (大纲)                      │
└─────────────────────────────────────────────────┘
```

---

### 步骤4：定稿章节

```
┌─────────────────────────────────────────────────┐
│            读取 chapter_N.txt                    │
└────────────────┬────────────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────────────┐
│          步骤4.1：更新前文摘要                   │
│  • 读取 global_summary.txt                      │
│  • AI总结本章要点                               │
│  • 追加到摘要文件                               │
└────────────────┬────────────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────────────┐
│          步骤4.2：更新角色状态                   │
│  • 读取 character_state.txt                     │
│  • AI分析角色变化                               │
│  • 更新状态文件                                 │
└────────────────┬────────────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────────────┐
│          步骤4.3：更新剧情要点（可选）           │
│  • 读取 plot_arcs.txt                           │
│  • AI识别新伏笔 / 解决旧伏笔                    │
│  • 按ABC级分类记录                              │
└────────────────┬────────────────────────────────┘
                 │
                 ↓
         ┌───────┴───────┐
         │ 每10章？      │
         └───────┬───────┘
           是 ↓     ↓ 否
              │     │
    ┌─────────┘     └─────────┐
    │                         │
    ↓                         ↓
┌─────────────┐       ┌───────────────┐
│ 智能压缩    │       │ 提炼核心伏笔  │
│ A级≤30条   │       │ A级5条        │
│ B级≤10条   │       │ B级3条        │
│ C级≤3条    │       │ ≤200字        │
└──────┬──────┘       └───────┬───────┘
       │                     │
       └──────────┬──────────┘
                  │
                  ↓
┌─────────────────────────────────────────────────┐
│          步骤4.4：存入向量库（可选）             │
│  • 切分章节文本                                 │
│  • 向量化并存储                                 │
│  • 供后续章节检索使用                           │
└────────────────┬────────────────────────────────┘
                 │
                 ↓
         ┌───────┴───────┐
         │ 卷结束？      │
         └───────┬───────┘
           是 ↓     ↓ 否
              │     │
    ┌─────────┘     └─────────┐
    │                         │
    ↓                         ↓
┌─────────────┐         ┌──────────┐
│ 生成卷摘要  │         │ 完成定稿 │
│ 清空全局摘要│         └──────────┘
└─────────────┘
```

---

## 📚 分卷模式

```
┌─────────────────────────────────────────────────┐
│                第1卷（1-30章）                   │
│  ┌──────┐  ┌──────┐       ┌──────┐             │
│  │第1章 │→ │第2章 │→ ... →│第30章│             │
│  └──────┘  └──────┘       └───┬──┘             │
│                                │                │
│                                ↓                │
│                    ┌─────────────────┐          │
│                    │ 生成卷摘要      │          │
│                    │ volume_1_       │          │
│                    │ summary.txt     │          │
│                    └────────┬────────┘          │
└─────────────────────────────┼───────────────────┘
                              │
                              ↓ 传递摘要
┌─────────────────────────────┼───────────────────┐
│                第2卷（31-70章）                  │
│  ┌──────┐  ┌──────┐       ┌──────┐             │
│  │第31章│→ │第32章│→ ... →│第70章│             │
│  └──────┘  └──────┘       └───┬──┘             │
│                                │                │
│                                ↓                │
│                    ┌─────────────────┐          │
│                    │ 生成卷摘要      │          │
│                    │ volume_2_       │          │
│                    │ summary.txt     │          │
│                    └────────┬────────┘          │
└─────────────────────────────┼───────────────────┘
                              │
                              ↓ 传递摘要
┌─────────────────────────────┼───────────────────┐
│               第3卷（71-100章）                  │
│  ┌──────┐  ┌──────┐       ┌───────┐            │
│  │第71章│→ │第72章│→ ... →│第100章│            │
│  └──────┘  └──────┘       └───┬───┘            │
│                                │                │
│                                ↓                │
│                    ┌─────────────────┐          │
│                    │ 生成卷摘要      │          │
│                    │ volume_3_       │          │
│                    │ summary.txt     │          │
│                    └─────────────────┘          │
└─────────────────────────────────────────────────┘
```

---

## 🔍 向量检索机制

```
┌─────────────────────────────────────────────────┐
│              正在写第50章                        │
└────────────────┬────────────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────────────┐
│              查询向量库                          │
│  输入：第50章的情节概要                         │
└────────────────┬────────────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────────────┐
│            向量相似度匹配                        │
│                                                 │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐      │
│  │ 第5章   │   │ 第23章  │   │ 第38章  │      │
│  │ 相关度: │   │ 相关度: │   │ 相关度: │      │
│  │  0.85   │   │  0.78   │   │  0.72   │      │
│  └────┬────┘   └────┬────┘   └────┬────┘      │
│       │             │             │            │
└───────┼─────────────┼─────────────┼────────────┘
        │             │             │
        └─────────┬───┴─────────┬───┘
                  │             │
                  ↓             ↓
┌─────────────────────────────────────────────────┐
│          组合相关上下文                          │
│  • 第5章：主角获得神秘玉佩                      │
│  • 第23章：玉佩发光显示地图                     │
│  • 第38章：师父提到玉佩的传说                   │
└────────────────┬────────────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────────────┐
│         AI参考这些内容写第50章                   │
│  → 保持剧情连贯，不会忘记之前的伏笔             │
└─────────────────────────────────────────────────┘
```

---

## 🎭 伏笔管理（ABC分级）

```
┌─────────────────────────────────────────────────┐
│            完成一章后识别伏笔                    │
└────────────────┬────────────────────────────────┘
                 │
                 ↓
         ┌───────┴───────┐
         │  AI分析伏笔   │
         └───────┬───────┘
                 │
        ┌────────┼────────┐
        │        │        │
        ↓        ↓        ↓
┌─────────┐ ┌─────────┐ ┌─────────┐
│🔴 A级  │ │🟡 B级  │ │🟢 C级  │
│  主线  │ │  支线  │ │  细节  │
└────┬────┘ └────┬────┘ └────┬────┘
     │           │           │
     ↓           ↓           ↓
 世界观谜团   配角背景    物品来源
 主角身世     势力冲突    小道具
 最终boss     次要情节    一次性角色
     │           │           │
     └─────┬─────┴─────┬─────┘
           │           │
           ↓           ↓
┌─────────────────────────────────────────────────┐
│          记录到 plot_arcs.txt                    │
│                                                 │
│  📌 未解决伏笔（至第50章）                      │
│   [A级-主线] 主角真实身份之谜（第3章）          │
│   [A级-主线] 远古遗迹中的预言（第5章）          │
│   [B级-支线] 二师兄的过往恩怨（第8章）          │
│   [C级-细节] 玉佩的来历（第12章）               │
│                                                 │
│  ✅ 已解决伏笔                                  │
│   ✓已解决: 入门考核的真相 → 第15章揭晓         │
└────────────────┬────────────────────────────────┘
                 │
                 ↓
         ┌───────┴───────┐
         │ 每10章检查    │
         │ 是否超限？    │
         └───────┬───────┘
           是 ↓     ↓ 否
              │     │
    ┌─────────┘     └─────────┐
    │                         │
    ↓                         ↓
┌─────────────┐       ┌───────────────┐
│ 智能压缩    │       │ 提炼核心伏笔  │
│             │       │               │
│ A级 → ≤30条│       │ 选A级5条      │
│ B级 → ≤10条│       │ 选B级3条      │
│ C级 → ≤3条 │       │ 控制≤200字    │
│             │       │               │
│ 合并相关伏笔│       │ 追加到摘要    │
└─────────────┘       └───────────────┘
```

---

## 📊 文件依赖关系

```
                    用户配置
                       │
                       ↓
        ┌──────────────────────────┐
        │   config.json            │
        │   prompts_config.json    │
        └──────────┬─────────────────┘
                   │
                   ↓
        ┌──────────────────────────┐
        │  Novel_architecture.txt  │ ←┐
        │  character_state.txt     │  │ 步骤1
        │  Volume_architecture.txt │  │
        └──────────┬─────────────────┘ │
                   │                   │
                   ↓                   │
        ┌──────────────────────────┐  │
        │  Novel_directory.txt     │ ←┘ 步骤2
        └──────────┬─────────────────┘
                   │
                   ↓
        ┌──────────────────────────┐
        │  chapter_1.txt           │
        │  chapter_2.txt           │ ← 步骤3
        │  ...                     │
        │  chapter_N.txt           │
        └──────────┬─────────────────┘
                   │
         ┌─────────┼─────────┐
         │         │         │
         ↓         ↓         ↓
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│global_summary│ │character_    │ │plot_arcs.txt │
│.txt          │ │state.txt     │ │              │
└──────┬───────┘ └──────────────┘ └──────────────┘
       │                                  │
       ↓                                  │
┌──────────────┐                          │
│volume_X_     │                          │
│summary.txt   │                          │
└──────────────┘                          │
                                          │
       ┌──────────────────────────────────┘
       │
       ↓
┌──────────────┐
│ vectorstore/ │ ←──────┐
│  (向量数据库)│         │
└──────┬───────┘         │
       │                 │
       └─────检索────────┘
```

---

## ⚡ 层级架构定位

```
┌─────────────────────────────────────────────────┐
│ 层级1：总体架构（全书格局）                      │
│  ↓ 在 Novel_architecture.txt 中定义             │
│  • 主线剧情                                     │
│  • 核心矛盾                                     │
│  • 最终走向                                     │
├─────────────────────────────────────────────────┤
│ 层级2：分卷架构（分卷格局）                      │
│  ↓ 在 Volume_architecture.txt 中定义            │
│  • 第1卷：开端与铺垫                            │
│  • 第2卷：发展与转折                            │
│  • 第3卷：高潮与结局                            │
├─────────────────────────────────────────────────┤
│ 层级3：章节目录（章节规划）                      │
│  ↓ 在 Novel_directory.txt 中定义                │
│  • 每章标题                                     │
│  • 每章大纲                                     │
│  • 推进分卷剧情                                 │
├─────────────────────────────────────────────────┤
│ 层级4：章节正文（具体内容）                      │
│  ↓ 在 chapter_X.txt 中生成                      │
│  • 场景描写                                     │
│  • 对话互动                                     │
│  • 情节推进                                     │
└─────────────────────────────────────────────────┘

     每一层都服务于上一层
     每一层都约束下一层
```

---

## 📁 最终输出结构

```
小说项目文件夹/
│
├── 📄 配置文件
│   ├── config.json              (API配置)
│   └── prompts_config.json      (提示词配置)
│
├── 📄 架构文件
│   ├── Novel_architecture.txt   (总体架构)
│   ├── Volume_architecture.txt  (分卷架构，可选)
│   └── Novel_directory.txt      (章节目录)
│
├── 📁 章节文件
│   ├── chapter_1.txt
│   ├── chapter_2.txt
│   ├── ...
│   ├── chapter_100.txt
│   ├── outline_1.txt
│   ├── outline_2.txt
│   └── ...
│
├── 📄 状态文件
│   ├── global_summary.txt       (全局摘要)
│   ├── character_state.txt      (角色状态)
│   └── plot_arcs.txt            (剧情要点)
│
├── 📁 分卷摘要（分卷模式）
│   ├── volume_1_summary.txt
│   ├── volume_2_summary.txt
│   └── volume_3_summary.txt
│
└── 📁 向量数据库（可选）
    └── vectorstore/
        └── chroma.sqlite3
```

---

## 💡 核心理念

```
┌──────────────────────────────────────────┐
│          输入                            │
│   主题 + 类型 + 章节数                   │
└─────────────┬────────────────────────────┘
              │
              ↓
┌──────────────────────────────────────────┐
│         AI自动生成                       │
│   架构 → 目录 → 草稿 → 定稿              │
└─────────────┬────────────────────────────┘
              │
              ↓
┌──────────────────────────────────────────┐
│          输出                            │
│   完整的小说 + 配套文件                  │
└──────────────────────────────────────────┘

核心：全程AI驱动，人工审核优化
```

---

**版本**: v4.0 框线图版本
**日期**: 2025-10-03
**说明**: 使用ASCII字符框线展示流程关系
