# 角色状态管理优化方案 - 测试验证指南

## 📋 概述

本文档提供完整的测试验证步骤，用于确保角色状态管理优化方案已正确实施并能正常工作。

**优化目标**：
- ✅ 核心角色遗漏率：30-40% → **0%**
- ✅ 角色状态完整性：60% → **95%+**
- ✅ 状态文档精简度：**+30-50%**
- ✅ 分卷一致性：70% → **95%+**
- ✅ 死亡角色处理：无规范 → **100%规范化**

---

## ✅ 1. 单元测试验证（已完成）

### 1.1 运行单元测试脚本

```bash
cd D:\project\AutoNovel
python tests\manual\test_character_state_optimization.py
```

### 1.2 测试覆盖范围

**测试1: read_character_dynamics() 函数**
- ✅ 文件不存在的情况（返回空字符串）
- ✅ 文件存在且有内容（正确读取）
- ✅ 文件存在但为空（返回空字符串）

**测试2: get_context_summary_for_character() 函数**
- ✅ 非分卷模式（num_volumes=0/1）
- ✅ 第一卷（分卷模式，仅 global_summary）
- ✅ 第二卷及以后（上一卷摘要 + 本卷摘要）
- ✅ 异常参数处理（total_chapters <= 0）
- ✅ 上一卷摘要缺失处理

**测试3: 提示词占位符验证**
- ✅ 所有必需占位符存在
- ✅ 提示词格式化成功
- ✅ 关键指令完整

### 1.3 测试结果

```
总计: 3/3 项测试通过
🎉 所有测试全部通过！优化方案核心逻辑验证成功！
```

---

## 🧪 2. GUI功能测试（需手动执行）

### 2.1 测试准备

1. **启动GUI**：
   ```bash
   D:\project\AutoNovel\run_gui.bat
   ```

2. **配置LLM**：
   - 在"配置"页签中配置好LLM API
   - 建议使用小模型测试（如 deepseek-chat）

### 2.2 测试场景1：非分卷模式（验证核心角色不遗漏）

**测试步骤**：

1. **创建测试项目**：
   - 主题：科幻冒险
   - 章节数：10章
   - 分卷数：0（不分卷）
   - 输出路径：`D:\test_autonovel\test_non_volume`

2. **生成架构**：
   - 点击"Step1 生成总体架构"
   - **✅ 验证点1**：检查是否生成了 `character_dynamics.txt` 文件
   - 打开文件，查看是否包含核心角色定义（主角、配角、反派）

3. **生成目录**：
   - 点击"Step2 生成章节蓝图"
   - 等待生成完成

4. **生成第1章草稿**：
   - 章节号：1
   - 点击"Step3 生成章节草稿"
   - **✅ 验证点2**：查看日志输出，是否有"读取角色框架..."提示

5. **定稿第1章**：
   - 章节号：1
   - 点击"Step4 定稿章节"
   - **✅ 验证点3**：查看日志输出，确认以下步骤：
     ```
     ▶ [2/3] 更新角色状态
        ├─ 读取旧状态...
        ├─ 读取角色框架...
        ├─ 读取上下文摘要...
        ├─ 向LLM发起请求...
        └─ ✅ 角色状态更新完成
     ```

6. **检查角色状态文件**：
   - 打开 `character_state.txt`
   - **✅ 验证点4**：确认所有核心角色都在主要角色列表中
   - **✅ 验证点5**：即使未在第1章出场的核心角色也应有初始状态

7. **继续生成后续章节**（第2-5章）：
   - 重复步骤4-6
   - **✅ 验证点6**：观察角色状态变化，核心角色不应被降级或删除
   - **✅ 验证点7**：临时角色（如店小二）应在淡出后被删除

**预期结果**：
- ✅ 核心角色（角色动力学中定义）永不遗漏
- ✅ 核心角色即使多章未出场也保留在主要角色列表
- ✅ 临时角色正确删除，状态文档精简

---

### 2.3 测试场景2：分卷模式（验证跨卷摘要传递）

**测试步骤**：

1. **创建测试项目**：
   - 主题：玄幻修仙
   - 总章节数：70章
   - 分卷数：3卷
   - 输出路径：`D:\test_autonovel\test_volume`

2. **生成架构和目录**：
   - 执行 Step1 和 Step2
   - **✅ 验证点1**：检查是否生成了 `Volume_architecture.txt` 和 `character_dynamics.txt`

3. **第一卷测试（第1-20章）**：
   - 生成并定稿第1章
   - **✅ 验证点2**：查看日志，确认"非分卷模式：仅使用 global_summary.txt"或"第一卷：仅使用 global_summary.txt"
   - 继续生成第10章、第20章
   - **✅ 验证点3**：定稿第20章后，查看日志是否生成了 `volume_1_summary.txt`

4. **第二卷测试（第21-40章）**：
   - 生成并定稿第21章
   - **✅ 验证点4**：查看日志，确认：
     ```
     ├─ 读取上下文摘要...
     分卷模式：第2卷，传递上一卷+本卷摘要
     ```
   - **✅ 验证点5**：检查传递的摘要是否包含：
     - `【上一卷完整摘要】` + `volume_1_summary.txt` 内容
     - `【本卷累积摘要】` + `global_summary.txt` 内容
   - 继续生成第30章、第40章
   - **✅ 验证点6**：定稿第40章后，生成 `volume_2_summary.txt`，`global_summary.txt` 被清空

5. **第三卷测试（第41-70章）**：
   - 生成并定稿第41章
   - **✅ 验证点7**：确认传递了 `volume_2_summary.txt`（上一卷）

**预期结果**：
- ✅ 第一卷：仅使用 `global_summary.txt`
- ✅ 第二卷及以后：正确传递 `volume_{N-1}_summary.txt` + `global_summary.txt`
- ✅ 每卷最后一章定稿后生成卷摘要并清空全局摘要

---

### 2.4 测试场景3：角色生命周期管理

**测试步骤**：

1. **核心角色死亡测试**：
   - 在某章中让核心角色（如主要配角）死亡
   - 定稿该章后查看 `character_state.txt`
   - **✅ 验证点1**：死亡角色应：
     - 保留在主要角色列表（不被删除）
     - 标记【已死亡】
     - 保留"遗产/影响"信息

2. **非核心角色降级测试**：
   - 在前几章中让一个有名字的配角（非核心）出场
   - 该角色提升为主要角色
   - 后续5-10章中不再出现该角色
   - **✅ 验证点2**：该角色应：
     - 结合摘要判断不再活跃 → 降级到"新出场角色"
     - 继续不活跃 → 最终删除

3. **临时角色删除测试**：
   - 让一个临时角色（如路人甲、店小二）出场
   - 该角色留在"新出场角色"区
   - 后续章节不再出现
   - **✅ 验证点3**：该角色应直接从"新出场角色"中删除

**预期结果**：
- ✅ S级核心角色：永不删除，死亡时标记【已死亡】
- ✅ A级非核心主要角色：可降级、可删除
- ✅ B级临时角色：淡出后直接删除

---

### 2.5 测试场景4：旧版兼容性测试

**测试步骤**：

1. **旧项目测试**：
   - 准备一个旧版本生成的项目（没有 `character_dynamics.txt`）
   - 尝试定稿新章节
   - **✅ 验证点1**：查看日志，确认：
     ```
     ├─ 读取角色框架...
     │  └─ ⚠️ 角色框架缺失，仅基于当前状态更新
     ```
   - **✅ 验证点2**：定稿流程应正常完成，不报错

2. **旧自定义模板测试**：
   - 备份当前的 `custom_prompts/update_character_state_prompt.txt`
   - 用旧版模板覆盖（缺少 `{character_dynamics}` 和 `{context_summary}` 占位符）
   - 尝试定稿章节
   - **✅ 验证点3**：查看日志，确认：
     ```
     │  └─ ⚠️ 自定义模板缺少占位符 'character_dynamics'，使用默认模板
     ```
   - **✅ 验证点4**：定稿流程应使用默认模板完成，不报错

**预期结果**：
- ✅ 旧项目优雅降级，功能部分可用
- ✅ 旧自定义模板自动回退到默认模板

---

## 📊 3. 效果验证

### 3.1 核心角色遗漏率验证

**验证方法**：
1. 生成10章小说（包含5个核心角色）
2. 统计每章定稿后 `character_state.txt` 中核心角色的存在情况

**评估标准**：
- ✅ 优秀：5/5 核心角色始终存在（0%遗漏率）
- ⚠️ 需改进：<5/5 核心角色存在（有遗漏）

### 3.2 状态文档精简度验证

**验证方法**：
1. 对比优化前后 `character_state.txt` 的文件大小和角色数量
2. 统计临时角色的删除情况

**评估标准**：
- ✅ 优秀：临时角色淡出后及时删除，主要角色列表保持精简
- ⚠️ 需改进：大量不活跃角色堆积，文档持续膨胀

### 3.3 分卷一致性验证

**验证方法**：
1. 在分卷模式下生成跨卷小说
2. 检查第二卷及以后是否正确传递上一卷摘要

**评估标准**：
- ✅ 优秀：跨卷角色状态连贯，无断层
- ⚠️ 需改进：跨卷信息丢失，角色状态断层

---

## 🐛 4. 常见问题排查

### 4.1 "character_dynamics.txt 不存在"警告

**原因**：旧项目或角色动力学模块被禁用

**解决方案**：
1. 重新生成架构（确保角色动力学模块启用）
2. 或忽略警告，系统会优雅降级

### 4.2 "自定义模板缺少占位符"警告

**原因**：使用了旧版自定义提示词模板

**解决方案**：
1. 删除旧的自定义模板：`custom_prompts/update_character_state_prompt.txt`
2. 或手动添加新占位符：`{character_dynamics}` 和 `{context_summary}`

### 4.3 分卷模式下摘要传递异常

**原因**：`total_chapters` 参数未配置或为0

**解决方案**：
1. 确保在配置中正确设置总章节数
2. 系统会自动回退到仅使用 `global_summary.txt`

### 4.4 角色状态更新失败

**原因**：LLM返回格式错误或API异常

**解决方案**：
1. 查看 `logs/app.log` 日志定位错误
2. 检查LLM配置和网络连接
3. 手动编辑 `character_state.txt` 修正

---

## 📝 5. 测试报告模板

完成测试后，请按以下模板记录测试结果：

```markdown
## 角色状态管理优化方案测试报告

**测试日期**：2025-10-XX
**测试人员**：XXX
**项目版本**：v1.0

### 单元测试结果
- [✅] read_character_dynamics() - 通过
- [✅] get_context_summary_for_character() - 通过
- [✅] 提示词占位符验证 - 通过

### GUI功能测试结果

#### 场景1：非分卷模式
- [✅/❌] character_dynamics.txt 生成
- [✅/❌] 核心角色不遗漏
- [✅/❌] 临时角色正确删除
- **遗漏率**：X/5 核心角色（X%）

#### 场景2：分卷模式
- [✅/❌] 第一卷摘要传递正确
- [✅/❌] 第二卷跨卷摘要传递正确
- [✅/❌] 卷摘要生成和清空正确

#### 场景3：角色生命周期
- [✅/❌] 核心角色死亡处理正确
- [✅/❌] 非核心角色降级正确
- [✅/❌] 临时角色删除正确

#### 场景4：兼容性
- [✅/❌] 旧项目兼容
- [✅/❌] 旧模板兼容

### 效果评估
- **核心角色遗漏率**：优化前 XX% → 优化后 XX%
- **状态文档精简度**：优化前 XX 角色 → 优化后 XX 角色（精简 XX%）
- **分卷一致性**：[优秀/良好/需改进]

### 问题记录
1. [问题描述]
2. [解决方案]

### 总体评价
[优秀/良好/需改进]

### 建议
[改进建议]
```

---

## ✅ 6. 验收标准

优化方案通过验收需满足以下条件：

1. **✅ 单元测试**：3/3 项测试全部通过
2. **✅ 核心角色遗漏率**：≤ 5%（目标0%）
3. **✅ 状态文档精简度**：临时角色删除率 ≥ 80%
4. **✅ 分卷一致性**：跨卷摘要传递 100% 正确
5. **✅ 兼容性**：旧项目和旧模板均能正常运行
6. **✅ 无严重Bug**：无导致程序崩溃的错误

---

## 📞 7. 支持与反馈

如在测试过程中遇到问题，请：

1. **查看日志**：`logs/app.log`
2. **参考文档**：`角色状态管理优化方案.md`
3. **提交Issue**：记录问题详情和复现步骤

**文档版本**：v1.0
**最后更新**：2025-10-04
