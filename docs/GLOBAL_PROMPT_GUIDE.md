# Global System Prompt 使用指南

## 📖 概述

`global_prompt.json` 支持两种格式配置全局 System Prompt：
1. **字符串格式**（简单直接，向后兼容）
2. **JSON对象格式**（结构化配置，推荐使用）

---

## 🎯 格式1：字符串格式

**适用场景**：简单的 prompt 配置

**示例：**
```json
{
  "system_prompt": "你是一位资深的网络小说编辑，擅长创作玄幻、都市、科幻等多种类型的网络小说。"
}
```

**优点**：
- ✅ 简单直接
- ✅ 完全向后兼容
- ✅ 适合短小的 prompt

---

## 🚀 格式2：JSON对象格式（推荐）

**适用场景**：复杂的、结构化的 prompt 配置

**完整示例：**
```json
{
  "system_prompt": {
    "role": "资深网络小说编辑",
    "style": "符合网文读者阅读习惯，情节紧凑，爽点密集",
    "tone": "第三人称全知视角，叙事流畅自然",
    "pacing": "开篇30%建立情境，中段40%推进冲突，结尾30%高潮与转折",
    "output_format": "纯文本，不使用markdown标记符号",
    "language": "简体中文，用词准确",
    "constraints": [
      "每章字数严格控制在配置范围内",
      "保持角色性格一致性",
      "剧情逻辑自洽",
      "避免重复内容"
    ],
    "rules": [
      "优先展现冲突和矛盾",
      "每章至少包含1-2个爽点",
      "重要情节需埋下伏笔",
      "描写要具体生动"
    ]
  }
}
```

**转换后的文本：**
```
你的角色：资深网络小说编辑
写作风格：符合网文读者阅读习惯，情节紧凑，爽点密集
语气与视角：第三人称全知视角，叙事流畅自然
节奏控制：开篇30%建立情境，中段40%推进冲突，结尾30%高潮与转折
输出格式：纯文本，不使用markdown标记符号
语言要求：简体中文，用词准确
约束条件：
  - 每章字数严格控制在配置范围内
  - 保持角色性格一致性
  - 剧情逻辑自洽
  - 避免重复内容
遵循规则：
  1. 优先展现冲突和矛盾
  2. 每章至少包含1-2个爽点
  3. 重要情节需埋下伏笔
  4. 描写要具体生动
```

---

## 📝 支持的预定义字段

| 字段 | 说明 | 类型 | 示例 |
|------|------|------|------|
| `role` | 角色定位 | 字符串 | `"资深网络小说编辑"` |
| `style` | 写作风格 | 字符串 | `"简洁明了，节奏紧凑"` |
| `tone` | 语气与视角 | 字符串 | `"第三人称全知视角"` |
| `pacing` | 节奏控制 | 字符串 | `"前30%铺垫，后70%高潮"` |
| `output_format` | 输出格式 | 字符串 | `"纯文本"` |
| `language` | 语言要求 | 字符串 | `"简体中文"` |
| `priority` | 优先级 | 字符串 | `"质量 > 速度"` |
| `constraints` | 约束条件 | 列表/字符串 | `["字数3000", "逻辑自洽"]` |
| `rules` | 遵循规则 | 列表/字符串 | `["避免重复", "保持一致"]` |
| `guidelines` | 创作指南 | 字典/列表 | 见下方示例 |

---

## 🎨 高级用法

### 1. 使用 guidelines（创作指南）

**字典格式：**
```json
{
  "system_prompt": {
    "role": "小说编辑",
    "guidelines": {
      "角色塑造": "立体饱满，有成长弧线",
      "情节设计": "伏笔呼应，逻辑严密",
      "对话风格": "符合人设，推动剧情"
    }
  }
}
```

**列表格式：**
```json
{
  "system_prompt": {
    "role": "小说编辑",
    "guidelines": [
      "角色要有鲜明的性格特点",
      "情节要环环相扣",
      "对话要简洁有力"
    ]
  }
}
```

### 2. 自定义字段

除了预定义字段，你可以添加任意自定义字段：

```json
{
  "system_prompt": {
    "role": "网文作家",
    "target_audience": "18-35岁男性读者",
    "preferred_genres": ["玄幻", "修仙", "都市"],
    "forbidden_topics": ["政治敏感", "暴力血腥"],
    "writing_speed": "每章3000-5000字"
  }
}
```

自定义字段会自动转换：
```
你的角色：网文作家
Target Audience: 18-35岁男性读者
Preferred Genres: 玄幻, 修仙, 都市
Forbidden Topics: 政治敏感, 暴力血腥
Writing Speed: 每章3000-5000字
```

---

## 🔧 如何切换格式

### 从字符串切换到JSON对象

**之前（字符串）：**
```json
{
  "system_prompt": "你是专业小说编辑，请按要求创作高质量内容。"
}
```

**之后（JSON对象）：**
```json
{
  "system_prompt": {
    "role": "专业小说编辑",
    "constraints": ["高质量内容", "符合要求"]
  }
}
```

### 从JSON对象切换到字符串

只需将 `system_prompt` 的值改为字符串即可，完全向后兼容。

---

## 🧪 测试配置

运行测试脚本验证配置是否正确：

```bash
python test_global_prompt.py
```

测试脚本会：
1. ✅ 测试当前配置的JSON对象格式
2. ✅ 测试字符串格式兼容性
3. ✅ 测试自定义字段支持

---

## 💡 最佳实践

### 1. 推荐配置（网文创作）

```json
{
  "system_prompt": {
    "role": "资深网文编辑",
    "style": "爽文风格，节奏明快，冲突密集",
    "tone": "第三人称全知视角",
    "constraints": [
      "每章字数3000-5000",
      "每章至少2个爽点",
      "角色性格前后一致",
      "剧情逻辑自洽"
    ],
    "rules": [
      "优先展现冲突",
      "避免平铺直叙",
      "重要情节埋伏笔",
      "对话推动剧情"
    ],
    "output_format": "纯文本，无markdown",
    "language": "简体中文"
  }
}
```

### 2. 推荐配置（文学创作）

```json
{
  "system_prompt": {
    "role": "文学编辑",
    "style": "细腻深刻，注重心理描写",
    "tone": "第一人称或第三人称限知视角",
    "constraints": [
      "注重文学性和艺术性",
      "人物心理刻画细腻",
      "语言优美流畅",
      "避免俗套情节"
    ],
    "pacing": "舒缓自然，注重氛围营造",
    "language": "简体中文，文学性强"
  }
}
```

### 3. 空配置（使用默认）

如果暂时不需要全局 prompt，可以设置为空字符串：

```json
{
  "system_prompt": ""
}
```

或者在GUI中取消勾选"启用全局 System Prompt"。

---

## ⚠️ 注意事项

1. **JSON格式要求**：
   - 必须是合法的JSON格式
   - 字符串使用双引号 `""`，不能用单引号 `''`
   - 列表用方括号 `[]`，对象用花括号 `{}`

2. **字段名规范**：
   - 自定义字段名推荐使用英文和下划线
   - 会自动转换为 Title Case（如 `user_guidance` → `User Guidance`）

3. **特殊字符**：
   - 如果文本中包含引号，需要转义：`"这是\"引号\""`
   - 支持换行符 `\n`

4. **文件编码**：
   - `global_prompt.json` 必须使用 UTF-8 编码
   - 如果出现乱码，检查文件编码

---

## 🐛 故障排查

### 问题1：配置不生效

**原因**：可能没有在GUI中启用全局 System Prompt

**解决**：
1. 打开GUI
2. 在设置页签中勾选"启用全局 System Prompt"
3. 保存配置

### 问题2：JSON解析错误

**错误信息**：`global_prompt.json 解析失败`

**解决**：
1. 使用JSON校验工具检查语法（如 jsonlint.com）
2. 检查是否有多余的逗号或缺少引号
3. 确保文件编码为 UTF-8

### 问题3：转换后的文本为空

**原因**：JSON对象中所有字段都为空或无效

**解决**：
1. 至少配置一个有效字段（如 `role` 或 `style`）
2. 检查字段值是否为空字符串

---

## 📚 参考资料

- **代码文件**：`prompt_definitions.py`
- **测试脚本**：`test_global_prompt.py`
- **配置文件**：`global_prompt.json`

如有问题，请查看 `app.log` 日志文件获取详细错误信息。
