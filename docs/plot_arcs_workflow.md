# 剧情要点管理系统完整流程

## 📋 流程总览

```
定稿章节（finalize_chapter）
│
├─ [1/3] 更新前文摘要 → global_summary.txt
│
├─ [2/3] 更新角色状态 → character_state.txt
│
├─ [2.5/3] 更新剧情要点（详细版，按ABC级记录） → plot_arcs.txt
│   └─ 模块：plot_arcs_update
│   └─ 提示词：plot_arcs_update_prompt
│   └─ 输出格式：
│       [A级-主线] XXX
│       [B级-支线] XXX
│       [C级-细节] XXX
│       ✓已解决：XXX
│
├─ [2.6/3] 智能压缩（每10章触发）→ plot_arcs.txt（压缩后）
│   └─ 模块：plot_arcs_compress_auto
│   └─ 提示词：plot_arcs_compress_auto_prompt
│   └─ 触发条件：
│       - 章节号是10的倍数
│       - 未解决伏笔>50条 OR 已解决伏笔>20条
│   └─ 压缩规则：
│       - A级：≤30条（强制合并）
│       - B级：≤10条（最近20章）
│       - C级：≤3条（最近3章）
│       - 已解决：≤10条
│
├─ [2.8/3] 提炼伏笔到摘要（精简版，筛选ABC级）→ global_summary.txt
│   └─ 模块：plot_arcs_distill
│   └─ 提示词：plot_arcs_distill_prompt
│   └─ 筛选规则：
│       - A级：保留5条最核心
│       - B级：保留3条重要
│       - C级：不传递
│   └─ 输出格式：
│       ━━━ 未解决伏笔（至第X章） ━━━
│       [A级-主线] XXX
│       [B级-支线] XXX
│   └─ 字数超限处理：
│       如果>250字 → 触发 plot_arcs_compress（二次压缩）
│
└─ [3/3] 插入向量库
```

## 🔄 分卷模式额外流程

```
定稿卷末章节
│
└─ 生成卷摘要（finalize_volume）
    │
    ├─ 生成卷摘要文本 → volume_X_summary.txt
    │
    ├─ 附加A+B级伏笔到卷摘要
    │   └─ 从 global_summary.txt 提取伏笔
    │   └─ 筛选：仅保留 [A级-主线] 和 [B级-支线]
    │   └─ 输出格式：
    │       ━━━ 第X卷未解决伏笔 ━━━
    │       [A级-主线] XXX
    │       [B级-支线] XXX
    │
    ├─ 将卷摘要存入向量库
    │
    └─ 清空 global_summary.txt（为下一卷做准备）
```

## 📊 模块清单

### 使用中的模块

| 模块ID | 显示名称 | 步骤 | 用途 |
|--------|---------|-----|-----|
| `plot_arcs_update` | 剧情要点更新 | 2.5/3 | 记录未解决伏笔（按ABC级） |
| `plot_arcs_compress_auto` | 智能自动压缩 | 2.6/3 | 周期性压缩详细版（每10章，阈值：未解决>50条/已解决>20条，A级≤30条） |
| `plot_arcs_distill` | 伏笔提炼（精简版） | 2.8/3 | 提炼核心伏笔融入摘要 |
| `plot_arcs_compress` | 伏笔二次压缩 | 2.8/3 | 精简版超限时的紧急压缩 |

### 废弃的模块

| 模块ID | 原显示名称 | 废弃原因 |
|--------|-----------|---------|
| `plot_arcs_classify` | 伏笔分层标记 | 已优化：记录时直接分级，无需后续标记 |

## 🎯 数据流转

```
plot_arcs.txt（详细版）
    ↓ 步骤2.5 记录（按ABC级）
    ├─ [A级-主线] 20-50条
    ├─ [B级-支线] 10-30条
    ├─ [C级-细节] 5-20条
    └─ ✓已解决 50-100条

    ↓ 步骤2.6 压缩（每10章）
    ├─ [A级-主线] ≤30条
    ├─ [B级-支线] ≤10条
    ├─ [C级-细节] ≤3条
    └─ ✓已解决 ≤10条

    ↓ 步骤2.8 提炼（精简版）
global_summary.txt
    ━━━ 未解决伏笔（至第X章） ━━━
    ├─ [A级-主线] 5条
    └─ [B级-支线] 3条

    ↓ 卷末处理
volume_X_summary.txt
    ━━━ 第X卷未解决伏笔 ━━━
    ├─ [A级-主线] 全部
    └─ [B级-支线] 全部
```

## 🔧 分级标准

### [A级-主线]
直接影响故事核心走向的伏笔：
- 世界观谜团（如变异流感来源）
- 主角核心秘密（如陈默真实背景）
- 最终boss相关（如赵擎真实目的）

### [B级-支线]
影响重要配角或次要情节线的伏笔：
- 配角背景（如老鬼身份）
- 势力冲突（如远扬安保内部）
- 次要角色命运（如张小雷立场）

### [C级-细节]
仅影响局部细节的伏笔：
- 物品来源（如特殊装备）
- 小道具（如相框照片）
- 一次性角色（如路人）

## 📏 格式匹配规则（宽松匹配，提高鲁棒性）

### 未解决伏笔匹配
支持以下格式变体：
```
[A级-主线] 标准格式
- [A级-主线] 带短横线
• [B级-支线] 带圆点
· [C级-细节] 带中点
* [A级-主线] 带星号
  [A级-主线] 前导空格
[A级 - 主线] 分级标签带空格
```

**正则表达式**：`^\s*[-•·\*]?\s*\[([ABC]级[-\s]*[^\]]+)\]`

### 已解决伏笔匹配
支持以下格式变体：
```
✓已解决：标准checkmark
✅已解决：绿色checkmark
☑已解决：方框checkmark
✓ 已解决：带空格
✓已解决 无冒号
- ✓已解决：前导符号
```

**正则表达式**：`^\s*[-•·\*]?\s*[✓✅☑]\s*已解决[:：]?`

### 不匹配的格式
- 普通文本（无分级标签）
- [D级-...] 不存在的分级
- 已解决但没有符号
- [级-...] 格式不完整

## ⚠️ 重要约束

1. **记录员职责**：只记录不解决，不预测剧情
2. **A级硬性限制**：压缩后必须≤30条（通过合并实现）
3. **分级传递**：
   - 章节传递：A级（5条）+ B级（3条）
   - 卷传递：A级（全部）+ B级（全部）
4. **格式统一**：
   - 详细版：完整描述（≤30字/条）
   - 精简版：关键词化（≤20字/条）
   - 支持合并：用"/"分隔相关伏笔

## 📝 示例

### 详细版（plot_arcs.txt）
```
[A级-主线] 变异性流感的真实来源、传播方式及最终演变方向
[A级-主线] 赵擎将小区改造成军事管制区的最终图谋
[A级-主线] Gamma-02特殊免疫基因的具体价值与战略用途
[B级-支线] 陈默的神秘联络人"老鬼"及其代表的地下交易网络
[B级-支线] 张小雷对陈默的信任度变化与未来立场选择
[C级-细节] 陈默面朝下扣着的相框里藏着什么秘密

✓已解决：陈默首次外出任务成功返回
✓已解决：林晚的戒断反应得到控制
```

### 精简版（global_summary.txt）
```
━━━ 未解决伏笔（至第57章） ━━━
[A级-主线] 变异流感来源/传播机制
[A级-主线] 赵擎目的/筛选协议
[A级-主线] Gamma-02基因价值
[A级-主线] 陈默真实背景
[A级-主线] 小远父母下落
[B级-支线] "老鬼"网络身份
[B级-支线] 张小雷立场转变
[B级-支线] 镭射眼后续合作
```

### 卷摘要版（volume_1_summary.txt）
```
━━━ 第1卷未解决伏笔 ━━━
[A级-主线] 变异流感来源/传播机制
[A级-主线] 赵擎目的/筛选协议
[A级-主线] Gamma-02基因价值
[B级-支线] "老鬼"网络身份
[B级-支线] 张小雷立场转变
```
