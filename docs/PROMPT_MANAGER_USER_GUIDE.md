# 提示词管理系统 - 用户手册

## 目录
- [功能概述](#功能概述)
- [界面导航](#界面导航)
- [基础操作](#基础操作)
- [模块说明](#模块说明)
- [自定义提示词](#自定义提示词)
- [配置文件](#配置文件)
- [常见问题](#常见问题)

---

## 功能概述

提示词管理系统允许您：
- ✅ **启用/禁用** 任意可选模块，精简生成流程
- ✅ **自定义修改** 所有提示词内容，适配特定需求
- ✅ **一键重置** 恢复默认提示词
- ✅ **实时预览** 变量列表和中文说明
- ✅ **依赖检查** 自动防止误操作导致的错误

**访问路径**：主界面 → **提示词管理** 页签

---

## 界面导航

提示词管理界面分为三列布局：

```
┌──────────────┬────────────────────────┬──────────────┐
│  模块列表    │      提示词编辑器      │  操作面板    │
│              │                        │              │
│ ☑ 核心种子   │  # 提示词内容          │ ⚪ 启用/禁用 │
│ ☑ 角色动力学 │  主题：{topic}         │              │
│ ☑ 世界观构建 │  类型：{genre}         │ [保存修改]   │
│ ...          │  ...                   │ [重置默认]   │
│              │                        │              │
│              │                        │ 可用变量:    │
│              │                        │ • topic     │
│              │                        │ • genre     │
└──────────────┴────────────────────────┴──────────────┘
```

### 左侧：模块列表
- 按类别分组显示所有17个模块
- ✅ **勾选**：模块已启用
- ⬜ **未勾选**：模块已禁用
- 🔒 **灰色禁用**：必需模块，不可关闭

### 中间：提示词编辑器
- 显示当前选中模块的提示词内容
- 支持多行编辑，自动换行
- 使用 `{variable}` 格式插入变量

### 右侧：操作面板
- **启用开关**：快速切换模块状态（与左侧复选框同步）
- **保存修改**：保存编辑的提示词到文件
- **重置为默认**：恢复系统默认提示词
- **可用变量列表**：显示该模块支持的所有变量及中文说明

---

## 基础操作

### 1. 禁用可选模块

**场景**：您不想生成世界观设定，直接进入剧情架构。

**步骤**：
1. 在左侧模块列表找到 **"世界观构建"**
2. 取消勾选复选框
3. 系统自动保存配置
4. 下次生成架构时会跳过该模块

**注意事项**：
- 如果其他模块依赖该模块，会弹出警告，需先禁用依赖模块
- 必需模块（如"核心种子"）无法禁用

---

### 2. 自定义提示词

**场景**：您想修改角色动力学的生成逻辑。

**步骤**：
1. 点击左侧 **"角色动力学"** 模块
2. 在中间编辑器修改提示词内容
   ```
   基于以下核心种子，设计3-5个关键角色：
   {core_seed}

   要求：
   - 每个角色需要明确的动机和弧光
   - 关注角色之间的关系网络
   ```
3. 点击右侧 **"💾 保存修改"** 按钮
4. 系统保存到 `custom_prompts/character_dynamics.txt`

**提示**：
- 必须保留所有 `{variable}` 变量，否则生成时会报错
- 参考右侧 **"可用变量"** 列表，了解每个变量的含义

---

### 3. 重置为默认

**场景**：自定义提示词效果不佳，想恢复原版。

**步骤**：
1. 选中对应模块
2. 点击右侧 **"🔄 重置为默认"** 按钮
3. 确认对话框点击 **"是"**
4. 编辑器立即显示默认内容

**效果**：
- 删除 `custom_prompts/xxx.txt` 文件
- 下次生成时使用系统默认提示词

---

## 模块说明

### 架构生成（architecture）

#### 核心种子 ⭐ 必需
**作用**：生成小说的核心设定（主题、冲突、风格）
**依赖**：无
**建议**：保持启用，这是所有后续模块的基础

#### 角色动力学
**作用**：设计主要角色及其关系网络
**依赖**：无
**影响**：
- 禁用后，三幕式情节、初始角色状态无法生成角色相关内容
- 需先禁用依赖模块才能关闭

#### 世界观构建
**作用**：构建世界观设定（地理、历史、魔法体系等）
**依赖**：无
**影响**：
- 禁用后，三幕式情节无法引用世界观元素
- 适合现代都市题材禁用

#### 三幕式情节
**作用**：设计整体剧情结构（起、承、转、合）
**依赖**：角色动力学、世界观构建
**建议**：保持启用，提供全局剧情指导

#### 分卷架构
**作用**：为多卷小说生成每卷的独立架构
**依赖**：无
**触发条件**：仅当分卷数 > 1 时执行

---

### 目录生成（blueprint）

#### 章节蓝图 ⭐ 必需
**作用**：生成所有章节的标题和大纲
**依赖**：无
**说明**：不可禁用，是章节生成的前提

#### 分块蓝图 ⭐ 必需
**作用**：将大量章节分批生成蓝图，避免超出token限制
**依赖**：无
**触发条件**：章节数超过动态计算的阈值时自动使用

---

### 章节生成（chapter）

#### 首章草稿 ⭐ 必需
**作用**：生成第1章的初稿
**依赖**：无
**特点**：首章提示词包含开篇技巧和世界观引入

#### 续章草稿 ⭐ 必需
**作用**：生成第2章及以后的初稿
**依赖**：无
**特点**：自动检索历史剧情，保持连贯性

#### 章节摘要
**作用**：生成每章的简短摘要
**依赖**：无
**影响**：禁用后，前文摘要更新时无法使用章节摘要

---

### 定稿流程（finalization）

#### 前文摘要更新
**作用**：定稿后更新 `global_summary.txt`
**依赖**：无
**影响**：
- 禁用后，后续章节无法了解前文发展
- **不建议禁用**，除非短篇小说

#### 角色状态更新
**作用**：定稿后更新 `character_state.txt`
**依赖**：无
**影响**：
- 禁用后，角色成长轨迹不被记录
- 适合角色数量极少的小说

#### 卷总结生成
**作用**：生成每卷的完整摘要 `volume_X_summary.txt`
**依赖**：无
**触发条件**：仅分卷模式的每卷最后一章
**影响**：禁用后，跨卷剧情连贯性下降

---

### 辅助功能（helper）

#### 知识库搜索
**作用**：从向量库检索相关历史内容
**依赖**：无
**影响**：禁用后，章节生成无法引用历史剧情

#### 知识库过滤
**作用**：过滤检索结果，提取关键信息
**依赖**：无
**影响**：禁用后，检索结果可能冗长，浪费token

#### 初始角色状态
**作用**：基于角色动力学生成初始角色状态表
**依赖**：角色动力学
**触发时机**：架构生成时自动创建

#### 全局系统提示词
**作用**：为所有LLM调用注入统一的system prompt
**依赖**：无
**建议**：默认禁用，特殊需求时启用

---

## 自定义提示词

### 变量系统

所有提示词使用 Python 的 `.format()` 语法插入变量：

```python
主题：{topic}
类型：{genre}
章节数：{number_of_chapters}
每章字数：{word_number}
```

### 常用变量说明

| 变量名 | 中文说明 | 示例值 |
|--------|---------|--------|
| `topic` | 小说主题 | "修仙者的现代都市生活" |
| `genre` | 小说类型 | "玄幻" |
| `number_of_chapters` | 总章节数 | 50 |
| `word_number` | 每章字数 | 3000 |
| `core_seed` | 核心种子内容 | （系统生成的核心设定） |
| `character_dynamics` | 角色动力学内容 | （系统生成的角色设定） |
| `world_building` | 世界观内容 | （系统生成的世界观） |
| `novel_architecture` | 总体架构 | （完整架构文件内容） |
| `chapter_blueprint` | 章节蓝图 | （所有章节标题大纲） |
| `previous_chapters` | 前文内容 | （前N章正文） |
| `chapter_summary` | 章节摘要 | （近期章节摘要） |
| `global_summary` | 全局摘要 | （累积的前文摘要） |
| `character_state` | 角色状态 | （当前角色状态表） |
| `relevant_contexts` | 相关历史 | （向量检索结果） |
| `user_guidance` | 用户指导 | "侧重描写情感变化" |

**完整变量列表**：选中模块后查看右侧操作面板的"可用变量"部分。

---

### 自定义示例

#### 示例1：强化角色对话

**原始提示词**（节选）：
```
根据大纲生成章节正文...
```

**修改后**：
```
根据大纲生成章节正文，注意以下要点：

1. 对话要符合角色性格：
   {character_state}

2. 每段对话后添加动作描写，避免"你一言我一语"
3. 使用"显示而非告知"的技巧，通过对话展现冲突
```

---

#### 示例2：添加写作风格约束

**原始提示词**（节选）：
```
类型：{genre}
```

**修改后**：
```
类型：{genre}

写作风格要求：
- 句式多样化，长短句结合
- 每3段使用一次环境描写
- 避免"然而""但是"等转折词开头
- 使用五感描写（视觉、听觉、嗅觉、触觉、味觉）
```

---

## 配置文件

### prompts_config.json

**位置**：项目根目录
**作用**：存储所有模块的配置信息

**结构**：
```json
{
  "_version": "1.0",
  "modules": {
    "architecture": {
      "core_seed": {
        "enabled": true,           // 是否启用
        "required": true,          // 是否必需（不可禁用）
        "display_name": "核心种子",
        "description": "生成小说的核心设定",
        "file": "custom_prompts/core_seed.txt",  // 自定义文件路径
        "dependencies": [],        // 依赖的其他模块
        "variables": ["topic", "genre", ...]  // 支持的变量
      }
    }
  }
}
```

---

### custom_prompts/

**位置**：项目根目录
**作用**：存储用户自定义的提示词文件

**文件列表**：
```
custom_prompts/
├── core_seed.txt               # 核心种子
├── character_dynamics.txt      # 角色动力学
├── world_building.txt          # 世界观构建
├── plot_architecture.txt       # 三幕式情节
├── volume_breakdown.txt        # 分卷架构
├── chapter_blueprint.txt       # 章节蓝图
├── chunked_blueprint.txt       # 分块蓝图
├── first_chapter.txt           # 首章草稿
├── next_chapter.txt            # 续章草稿
├── chapter_summary.txt         # 章节摘要
├── summary_update.txt          # 前文摘要更新
├── character_state_update.txt  # 角色状态更新
├── volume_summary.txt          # 卷总结生成
├── knowledge_search.txt        # 知识库搜索
├── knowledge_filter.txt        # 知识库过滤
├── create_character_state.txt  # 初始角色状态
└── global_system.txt           # 全局系统提示词
```

**注意**：
- 文件不存在时，自动使用系统默认提示词
- 文件内容为空时，也会使用默认提示词
- 手动编辑文件后，重启应用生效

---

## 常见问题

### Q1: 为什么无法禁用某个模块？

**原因**：该模块被其他启用的模块依赖。

**解决方法**：
1. 查看弹出的错误提示，了解哪些模块依赖它
2. 按提示先禁用依赖模块
3. 再禁用目标模块

**示例**：
```
无法禁用 角色动力学

以下模块依赖它：
• 三幕式情节
• 初始角色状态

请先禁用这些模块，或保持启用状态。
```

**正确流程**：
1. 禁用"三幕式情节"
2. 禁用"初始角色状态"
3. 禁用"角色动力学" ✅

---

### Q2: 修改提示词后不生效？

**检查清单**：
1. ✅ 点击了"💾 保存修改"按钮
2. ✅ 提示词包含所有必需变量（参考右侧列表）
3. ✅ 重新生成内容（不是查看旧文件）

**变量缺失示例**（错误）：
```
# 缺少 {core_seed} 变量
生成角色设定...
```

**正确示例**：
```
# 包含所有变量
基于以下核心种子生成角色：
{core_seed}

用户指导：
{user_guidance}
```

---

### Q3: 配置文件损坏怎么办？

**症状**：应用启动时提示配置错误，自动创建默认配置。

**恢复步骤**：
1. 查找备份文件：`prompts_config.json.backup_YYYYMMDD_HHMMSS`
2. 用文本编辑器打开备份文件
3. 对比当前 `prompts_config.json`，找出错误
4. 修复错误后保存
5. 重启应用

**常见错误**：
- 缺少逗号或多余逗号
- 引号不匹配（"" 配对）
- 使用了中文标点符号（应使用英文标点）
- 缺少必需字段（`enabled`、`required`）

**验证JSON格式**：
使用在线工具验证JSON格式是否正确：https://jsonlint.com/

---

### Q4: 如何理解模块依赖关系？

**依赖图**：
```
核心种子（必需）
 └─→ 角色动力学
      ├─→ 三幕式情节
      └─→ 初始角色状态

核心种子（必需）
 └─→ 世界观构建
      └─→ 三幕式情节
```

**规则**：
- 箭头指向的模块依赖箭头来源的模块
- 禁用被依赖模块前，必须先禁用所有依赖它的模块
- 必需模块无法禁用

---

### Q5: 禁用模块后生成的内容会怎样？

**禁用可选模块的影响**：

| 禁用模块 | 生成时的行为 | 后续影响 |
|---------|------------|---------|
| 角色动力学 | 跳过角色设定 | 三幕式情节、初始角色状态无法生成角色内容 |
| 世界观构建 | 跳过世界观设定 | 三幕式情节无法引用世界观元素 |
| 三幕式情节 | 跳过情节架构 | 章节蓝图仅基于核心种子生成，缺少全局指导 |
| 前文摘要更新 | 定稿时不更新摘要 | 后续章节无法了解前文发展，连贯性下降 |
| 角色状态更新 | 定稿时不更新状态表 | 角色成长轨迹不被记录 |

**提示**：禁用模块时，系统会在提示词中插入 `[该模块已禁用，无相关设定]` 替换占位文本，避免LLM收到混淆信息。

---

### Q6: 如何备份我的自定义提示词？

**方法1：手动备份文件夹**
```
复制整个 custom_prompts/ 文件夹到安全位置
```

**方法2：版本控制**
```bash
# 如果使用Git
git add custom_prompts/
git commit -m "保存自定义提示词"
```

**恢复方法**：
将备份的文件夹覆盖回项目根目录即可。

---

### Q7: 可以同时使用多个提示词模板吗？

**不支持**。每个模块只有一个生效的提示词：
- 如果存在 `custom_prompts/xxx.txt`，使用自定义版本
- 否则使用系统默认版本

**变通方法**：
1. 保存多个版本的 `.txt` 文件（如 `core_seed_v1.txt`、`core_seed_v2.txt`）
2. 需要切换时，重命名为 `core_seed.txt` 覆盖现有文件
3. 重启应用生效

---

### Q8: 提示词管理会影响已生成的内容吗？

**不会**。提示词管理仅影响新生成的内容：
- 已保存的 `Novel_architecture.txt` 不会变化
- 已生成的章节文件不会重新生成

**如需重新生成**：
1. 删除对应文件（如 `Novel_architecture.txt`）
2. 删除 `partial_architecture.json`（架构生成的断点文件）
3. 重新执行生成操作

---

## 高级技巧

### 技巧1：分阶段禁用模块

**场景**：开始时使用完整流程，后期加速生成。

**实施**：
1. 前10章：启用所有模块，建立世界观和角色
2. 中期：禁用"世界观构建"，减少生成时间
3. 后期：禁用"角色状态更新"，角色已定型无需更新

---

### 技巧2：针对题材优化模块组合

**玄幻/奇幻小说**：
- ✅ 启用：核心种子、角色动力学、世界观构建、三幕式情节
- ⬜ 可选禁用：无

**现代都市**：
- ✅ 启用：核心种子、角色动力学、三幕式情节
- ⬜ 禁用：世界观构建（现实世界无需构建）

**短篇小说（<10章）**：
- ✅ 启用：核心种子、三幕式情节
- ⬜ 禁用：角色动力学、世界观构建、前文摘要更新

---

### 技巧3：变量占位符的高级用法

**条件性文本**：
```
{character_dynamics}

注意：如果角色动力学部分显示"已禁用"，请基于核心种子自行推断角色设定。
```

**多级引用**：
```
基于以下设定：
1. 核心种子：{core_seed}
2. 角色关系：{character_dynamics}
3. 世界观：{world_building}

综合以上三个维度，设计情节架构...
```

---

## 技术支持

**问题反馈**：项目 GitHub Issues
**文档版本**：v1.0 (2025-10-01)
**适用版本**：AutoNovel v2.0+

---

**祝您创作愉快！** 📚✨

