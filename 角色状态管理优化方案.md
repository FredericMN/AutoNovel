# 角色状态管理优化方案

## 📋 背景与问题分析

### 1. 当前存在的问题

#### 1.1 角色遗漏问题
**现象**：
- 初始架构生成时，`character_dynamics` 定义了所有核心角色
- 但生成初始角色状态时，可能只创建故事开局出场的角色
- 后续章节中首次出场的重要角色被遗漏，放入"新出场角色"简要描述区
- 一旦遗漏，角色永远停留在简化状态，无法自动补全完整信息

**影响**：
- 核心角色缺失完整状态（位置、物品、能力、行为动机、关系网）
- 导致后续章节生成时角色行为不一致、逻辑矛盾
- 角色动机无法正确驱动剧情发展

#### 1.2 参数传递不足
**现象**：
- 角色状态更新时，LLM仅能看到：
  - `chapter_text`（当前章节）
  - `old_state`（旧角色状态）
- 无法看到：
  - ❌ `character_dynamics`（角色框架定义）
  - ❌ 前文摘要（整体剧情上下文）
  - ❌ 上一卷摘要（分卷模式跨卷信息）

**影响**：
- LLM无法识别哪些是"架构定义的核心角色"，容易遗漏
- 无法基于整体剧情判断角色重要性和活跃度
- 分卷模式下缺少上一卷信息，角色状态断层

#### 1.3 升降级机制不完善
**现象**：
- ✅ 有升级：新出场角色 → 主要角色
- ❌ 无降级：主要角色无法降级或删除
- ❌ 无死亡处理：死亡角色无特殊标记

**影响**：
- 角色状态文档持续膨胀（包含大量不活跃角色）
- 死亡角色继续占用主要角色位
- 上下文token消耗过大

### 2. 根本原因分析

| 问题 | 根本原因 | 现有机制缺陷 |
|------|---------|-------------|
| 核心角色遗漏 | LLM无法识别架构角色 | 无架构参考，仅依赖提示词强调 |
| 参数不足 | 设计时未考虑上下文传递 | 仅传递2个参数（chapter_text, old_state）|
| 无降级机制 | 未设计角色生命周期管理 | 提示词仅说明"淡出可删除"，无具体规则 |
| 分卷断层 | 未区分首卷/后续卷摘要传递 | 未传递上一卷摘要，跨卷信息丢失 |

---

## 🎯 优化目标

1. **彻底解决核心角色遗漏**：角色动力学中的核心角色永不遗漏
2. **增强上下文感知**：传递角色框架和剧情摘要，提升判断准确性
3. **智能升降级**：基于摘要判断角色重要性，自动升降级
4. **分卷兼容**：正确传递跨卷摘要，保证连续性
5. **精简状态文档**：非核心不活跃角色可降级/删除

---

## 🛠️ 优化方案详细设计

### 方案1：独立保存角色动力学（解耦架构文件）

#### 1.1 实施位置
**文件**：`novel_generator/architecture.py`

**修改点**：在生成角色动力学后，立即单独保存到 `character_dynamics.txt`

**代码位置**：`architecture.py:309-317`（角色动力学生成完成后）

**修改内容**：
```python
# 原代码（第309-317行）
character_dynamics_result = invoke_with_cleaning(llm_adapter, prompt_character, system_prompt=system_prompt)
if not character_dynamics_result.strip():
    gui_log("   └─ ❌ 生成失败")
    logging.warning("character_dynamics_prompt generation failed.")
    save_partial_architecture_data(filepath, partial_data)
    return
gui_log("   └─ ✅ 角色动力学生成完成\n")
partial_data["character_dynamics_result"] = character_dynamics_result
save_partial_architecture_data(filepath, partial_data)

# 🆕 新增：单独保存角色动力学
character_dynamics_file = os.path.join(filepath, "character_dynamics.txt")
clear_file_content(character_dynamics_file)
save_string_to_txt(character_dynamics_result, character_dynamics_file)
gui_log("   ├─ 已保存至: character_dynamics.txt")
logging.info("character_dynamics.txt saved successfully")
```

#### 1.2 文件说明
**生成文件**：`character_dynamics.txt`
- 仅包含角色动力学部分，不包含世界观、剧情架构
- 供后续模块独立读取，避免解析 `Novel_architecture.txt`

**优势**：
- ✅ 避免正则提取的不可靠性
- ✅ 解耦架构文件，各模块独立读取所需部分
- ✅ 便于后续扩展（如角色编辑、角色导入等功能）

---

### 方案2：增强参数传递（传入角色框架+上下文摘要）

#### 2.1 工具函数新增

**文件**：`core/utils/file_utils.py`（或新建 `core/utils/character_utils.py`）

**⚠️ 前置要求**：需要在 `file_utils.py` 顶部添加 `import logging`（当前文件缺少此导入）

**函数1：读取角色动力学**
```python
# 需要在文件顶部添加：import logging

def read_character_dynamics(filepath: str) -> str:
    """
    读取 character_dynamics.txt 文件

    Args:
        filepath: 项目路径

    Returns:
        角色动力学文本，若文件不存在则返回空字符串
    """
    char_dynamics_file = os.path.join(filepath, "character_dynamics.txt")

    if not os.path.exists(char_dynamics_file):
        logging.warning("character_dynamics.txt 不存在，可能是旧项目或角色模块被禁用")
        return ""

    content = read_file(char_dynamics_file)
    if not content:
        logging.warning("character_dynamics.txt 为空")
        return ""

    logging.info(f"成功读取角色动力学，长度：{len(content)} 字符")
    return content
```

**函数2：获取上下文摘要（分卷兼容）**
```python
def get_context_summary_for_character(
    filepath: str,
    chapter_num: int,
    num_volumes: int,
    total_chapters: int
) -> str:
    """
    获取用于角色状态更新的上下文摘要（分卷兼容）

    逻辑：
    - 非分卷模式（num_volumes <= 1）：返回 global_summary.txt
    - 第一卷：返回 global_summary.txt（本卷累积）
    - 第二卷及以后：返回 volume_{N-1}_summary.txt + global_summary.txt

    Args:
        filepath: 项目路径
        chapter_num: 当前章节号
        num_volumes: 分卷数量（0或1表示不分卷）
        total_chapters: 总章节数

    Returns:
        格式化的上下文摘要文本
    """
    global_summary_file = os.path.join(filepath, "global_summary.txt")
    global_summary = read_file(global_summary_file) if os.path.exists(global_summary_file) else ""

    # 非分卷模式
    if num_volumes <= 1:
        logging.info("非分卷模式：仅使用 global_summary.txt")
        return global_summary

    # ⚠️ 参数校验：防止 total_chapters 未配置或异常
    if total_chapters <= 0:
        logging.warning(f"分卷模式下 total_chapters={total_chapters} 无效，回退为仅使用 global_summary")
        return global_summary

    # 分卷模式：判断当前卷号
    from core.utils.volume_utils import calculate_volume_ranges, get_volume_number

    volume_ranges = calculate_volume_ranges(total_chapters, num_volumes)
    current_volume = get_volume_number(chapter_num, volume_ranges)

    if current_volume == 1:
        # 第一卷：仅全局摘要
        logging.info("第一卷：仅使用 global_summary.txt")
        return global_summary
    else:
        # 第二卷及以后：上一卷摘要 + 本卷累积摘要
        prev_volume = current_volume - 1
        prev_volume_summary_file = os.path.join(
            filepath,
            f"volume_{prev_volume}_summary.txt"
        )

        prev_volume_summary = ""
        if os.path.exists(prev_volume_summary_file):
            prev_volume_summary = read_file(prev_volume_summary_file)
            logging.info(f"读取上一卷摘要：volume_{prev_volume}_summary.txt")
        else:
            logging.warning(f"上一卷摘要不存在：volume_{prev_volume}_summary.txt")

        # 格式化组合摘要
        combined = f"""【上一卷完整摘要】
{prev_volume_summary if prev_volume_summary else '（上一卷摘要缺失）'}

【本卷累积摘要】
{global_summary if global_summary else '（本卷摘要为空）'}"""

        logging.info(f"分卷模式：第{current_volume}卷，传递上一卷+本卷摘要")
        return combined
```

#### 2.2 修改定稿流程

**文件**：`novel_generator/finalization.py`

**修改位置**：`finalization.py:390-419`（角色状态更新部分）

**修改内容**：
```python
# [2/3] 更新角色状态（可选）
if pm.is_module_enabled("finalization", "character_state_update"):
    update_progress("👤 [2/3] 更新角色状态", 0.75)
    gui_log("▶ [2/3] 更新角色状态")

    # 读取旧状态
    gui_log("   ├─ 读取旧状态...")
    character_state_file = os.path.join(filepath, "character_state.txt")
    old_character_state = read_file(character_state_file)

    # 🆕 读取角色动力学（独立文件）
    gui_log("   ├─ 读取角色框架...")
    from core.utils.file_utils import read_character_dynamics
    character_dynamics = read_character_dynamics(filepath)
    if not character_dynamics:
        gui_log("   │  └─ ⚠️ 角色框架缺失，仅基于当前状态更新")

    # 🆕 读取上下文摘要（分卷兼容）
    gui_log("   ├─ 读取上下文摘要...")
    from core.utils.file_utils import get_context_summary_for_character
    context_summary = get_context_summary_for_character(
        filepath=filepath,
        chapter_num=novel_number,
        num_volumes=num_volumes,
        total_chapters=total_chapters
    )

    # 格式化提示词
    prompt_template = pm.get_prompt("finalization", "character_state_update")
    if not prompt_template:
        gui_log("   └─ ⚠️ 提示词加载失败，使用默认提示词")
        prompt_template = update_character_state_prompt

    prompt_char_state = prompt_template.format(
        chapter_text=chapter_text,
        old_state=old_character_state,
        character_dynamics=character_dynamics,      # 🆕 传入角色框架
        context_summary=context_summary             # 🆕 传入上下文摘要
    )

    gui_log("   ├─ 向LLM发起请求...")
    new_char_state = invoke_with_cleaning(llm_adapter, prompt_char_state, system_prompt=system_prompt)

    if not new_char_state.strip():
        gui_log("   ├─ ⚠ 生成失败，保留旧状态")
        new_char_state = old_character_state
    else:
        gui_log("   └─ ✅ 角色状态更新完成\n")

    clear_file_content(character_state_file)
    save_string_to_txt(new_char_state, character_state_file)
else:
    gui_log(f"▷ [2/3] 更新角色状态 (已禁用，跳过)\n")
```

---

### 方案3：优化升降级策略（基于摘要判断）

#### 3.1 角色分级体系

```
┌─────────────────────────────────────────────────────┐
│ 【S级】角色动力学中的核心角色（不可降级/删除）      │
│  ├─ 永久保留完整状态                                │
│  ├─ 死亡时标记【已死亡】，保留最终状态              │
│  └─ 示例：主角、主要配角、最终反派                  │
├─────────────────────────────────────────────────────┤
│ 【A级】非核心的主要角色（可降级/删除）              │
│  ├─ 升级条件：有名字+持续影响剧情                   │
│  ├─ 降级条件：基于摘要判断不再活跃 → 新出场角色     │
│  ├─ 删除条件：降级后仍不活跃 → 完全删除             │
│  └─ 死亡时标记【已死亡】，降级后仍不活跃 → 完全删除  │
├─────────────────────────────────────────────────────┤
│ 【B级】临时角色/新出场角色（随时可删除）            │
│  ├─ 升级条件：对剧情有重要影响 → A级主要角色        │
│  ├─ 删除条件：淡出视线后直接删除                    │
│  └─ 死亡时直接删除                                  │
└─────────────────────────────────────────────────────┘
```

#### 3.2 提示词修改

**文件**：
- `custom_prompts/update_character_state_prompt.txt`
- `core/prompting/prompt_definitions.py:790-898`

**⚠️ 占位符兼容策略（重要）**：

新版提示词增加了 `{character_dynamics}` 和 `{context_summary}` 两个占位符。由于 `PromptManager` 优先读取用户自定义模板（`custom_prompts/`），旧模板缺少新占位符时会抛出 `KeyError`。

**应对方案**：
1. **代码层兼容**（推荐）：在 `finalization.py` 中使用 `try-except` 捕获 `KeyError`，回退到默认模板
   ```python
   try:
       prompt_char_state = prompt_template.format(
           chapter_text=chapter_text,
           old_state=old_character_state,
           character_dynamics=character_dynamics,
           context_summary=context_summary
       )
   except KeyError as e:
       gui_log(f"   │  └─ ⚠️ 自定义模板缺少占位符 {e}，使用默认模板")
       prompt_template = update_character_state_prompt  # 回退到默认
       prompt_char_state = prompt_template.format(...)
   ```

2. **用户提示**（辅助）：检测到旧模板时，在GUI日志中提示用户更新自定义模板
   ```python
   if "{character_dynamics}" not in prompt_template:
       gui_log("   │  └─ ⚠️ 检测到旧版自定义模板，建议更新或删除以使用新版")
   ```

3. **文档说明**（必备）：在实施步骤中明确提醒用户迁移自定义模板

**完整新版提示词**：
```
以下是新完成的章节文本：
{chapter_text}

━━━ 📚 参考背景信息 ━━━

【角色动力学框架】（仅供参考核心角色定义）
{character_dynamics}

【上下文摘要】（用于判断角色活跃度和剧情重要性）
{context_summary}

━━━ 当前角色状态文档 ━━━
{old_state}

⚠️ 角色更新原则：

1. **优先更新本章出场的角色**（详细更新所有模块）

2. **核心角色识别与保护**：
   - 从"角色动力学框架"中识别核心角色（主角、主要配角、反派等）
   - 核心角色必须始终保留在主要角色列表，即使本章未出场
   - 若核心角色首次出场，立即从"新出场角色"提升，补全完整状态结构

3. **角色提升判断**：
   - 从"新出场角色"中识别重要角色（有名字、有对话、持续影响剧情）
   - 结合上下文摘要判断：角色在后续剧情中是否有持续作用
   - 满足条件则提升为主要角色，移除"新出场角色"中的简要描述

4. **角色降级与清理策略**：

   ⚡ S级 - 核心角色（角色动力学中定义）：
      - 永不降级或删除，即使死亡也保留完整状态
      - 死亡时添加状态标记【已死亡】，停止更新物品/能力
      - 保留"遗产/影响"信息（如对其他角色的影响、留下的物品等）

   📉 A级 - 非核心主要角色（已提升但非动力学定义）：
      - 降级判断：结合上下文摘要，若角色在摘要中不再被提及 → 降级到"新出场角色"
      - 删除判断：降级后仍在后续章节无活跃表现 → 完全删除
      - 死亡时标记【已死亡】，降级到"新出场角色"，降级后仍在后续章节无活跃表现 → 完全删除

   🗑️ B级 - 临时角色（新出场角色区）：
      - 淡出视线后可直接删除（如店小二、路人甲）
      - 死亡或剧情完结角色直接删除

5. **判断依据说明**：
   - "上下文摘要"反映了整体剧情进展和角色活跃度
   - 若角色在摘要中被反复提及 → 说明重要，应保留/提升
   - 若角色在摘要中不再出现 → 说明不活跃，可考虑降级
   - 注意：不要机械判断"连续X章未出场"，而应综合剧情需要判断

请更新主要角色状态，内容格式：

例：
张三：
├──当前位置
│  ├──现实位置：【东玄大陆】→【天元国】→【云霞城】→【云霞宗·修炼殿】
│  ├──剧情位置：【与现实位置相同】
│  ├──位置状态：【静止】
│  └──位置备注：【正在闭关修炼】
├──物品:
│  ├──青衫：一件破损的青色长袍，带有暗红色的污渍
│  └──寒铁长剑：一柄断裂的铁剑，剑身上刻有古老的符文
├──能力
│  ├──技能1：强大的精神感知能力：能够察觉到周围人的心中活动
│  └──技能2：无形攻击：能够释放一种无法被视觉捕捉的精神攻击
├──状态
│  ├──身体状态: 身材挺拔，穿着华丽的铠甲，面色冷峻
│  └──心理状态: 目前的心态比较平静，但内心隐藏着对柳溪镇未来掌控的野心和不安
├──行为动机
│  ├──核心驱动力：对柳溪镇的掌控欲源于童年的无力感，渴望通过权力获得安全感
│  ├──当前目标：巩固在镇中的影响力，获取更多追随者
│  └──动机变化：[本章相比前一状态]本章因李四的背叛事件，掌控欲进一步增强，开始考虑使用更强硬的手段维持权威
├──主要角色间关系网
│  ├──李四：张三从小就与她有关联，对她的成长一直保持关注
│  └──王二：两人之间有着复杂的过去，最近因一场冲突而让对方感到威胁
├──触发或加深的事件
│  ├──村庄内突然出现不明符号：这个不明符号似乎在暗示柳溪镇即将发生重大事件
│  └──李四被刺穿皮肤：这次事件让两人意识到对方的强大实力，促使他们迅速离开队伍

角色名（【已死亡】标记示例）：
├──当前位置：【已死亡/已离场】
├──物品: （保留遗物清单）
├──能力: （不再更新）
├──状态
│  ├──身体状态: 【已死亡】
│  └──心理状态: （保留最终心理状态）
├──行为动机
│  ├──核心驱动力：（保留原有）
│  ├──当前目标：【已完结】
│  └──动机变化：本章因XXX事件死亡，遗愿/影响为XXX
├──主要角色间关系网: （保留）
├──触发或加深的事件: （保留死亡相关事件）
└──遗产/影响：（记录对其他角色的影响、留下的物品/秘密等）

......

新出场角色：
- 任何新增角色或临时出场人物的基本信息，简要描述即可，不要展开，淡出视线的角色可删除。

位置信息更新要求：
1. 现实位置：使用【层级1】→【层级2】→...格式，2-4层即可，根据章节实际描述的层级填写，不要虚构
2. 剧情位置：角色在现实中填【与现实位置相同】；在幻境/副本/游戏中填【具体名称】
3. 位置状态：根据本章内容选择【静止/移动中/传送中/意识沉浸】
4. 重要原则：本章未描述移动则位置不变；幻境/副本结束后剧情位置恢复【与现实位置相同】

行为动机更新要求：
1. **核心驱动力**：一般保持不变（除非角色经历重大人生转折，如信仰崩塌、价值观颠覆）
2. **当前目标**：根据本章剧情进展及时更新（如目标达成、目标转移、新目标出现）
3. **动机变化**：
   - 仅记录本章发生的变化（避免累积历史）
   - 必须明确指出触发变化的事件或原因
   - 若无明显变化，填写"无明显变化"即可
   - 重大变化示例：
     * "本章因亲人被害，复仇动机取代了原有的成名欲望"
     * "本章发现真相后，从盲目追随转变为开始质疑组织"
     * "本章目标达成（获得传承），新目标转向寻找失踪的师父"
4. **避免矛盾**：
   - 角色行为必须与动机匹配（不能目标是"保护朋友"，行为却是"见死不救"）
   - 动机转变需有充分理由支撑（不能无故突变）

要求：
- 请直接在已有文档基础上进行增删
- 不改变原有结构，语言尽量简洁、有条理

仅返回更新后的角色状态文本，不要解释任何内容。
```

---

## 📊 优化效果预期

### 定量指标

| 优化项 | 当前表现 | 优化后目标 | 提升幅度 |
|--------|---------|-----------|---------|
| **核心角色遗漏率** | 30-40% | **0%** | -100% |
| **角色状态完整性** | 60% | **95%+** | +58% |
| **状态文档精简度** | 基准 | **+30-50%** | 降低冗余 |
| **分卷一致性** | 70% | **95%+** | +36% |
| **死亡角色处理** | 无规范 | **100%规范化** | 新增 |

### 定性效果

1. **零遗漏**：角色动力学中的核心角色永不遗漏
2. **强感知**：LLM能基于框架+摘要准确判断角色重要性
3. **智能管理**：自动升降级，状态文档始终精简
4. **跨卷连贯**：分卷模式下正确传递上一卷信息
5. **生命周期**：从创建→活跃→降级→死亡/删除，全流程管理

---

## 🚀 实施步骤

### Step 1：新增独立文件保存（架构生成）
- [ ] 修改 `architecture.py:309-317`
- [ ] 生成角色动力学后，保存到 `character_dynamics.txt`
- [ ] 添加日志和GUI提示

### Step 2：新增工具函数（参数准备）
- [ ] 在 `core/utils/file_utils.py` 顶部添加 `import logging`（⚠️ 当前文件缺少此导入）
- [ ] 在 `core/utils/file_utils.py` 中新增：
  - `read_character_dynamics(filepath)` - 读取角色框架
  - `get_context_summary_for_character(...)` - 获取上下文摘要（分卷兼容）
  - ⚠️ 注意：`get_context_summary_for_character` 需增加 `total_chapters <= 0` 的校验

### Step 3：修改定稿流程（参数传递）
- [ ] 修改 `finalization.py:390-419`
- [ ] 调用新工具函数读取 `character_dynamics` 和 `context_summary`
- [ ] 传递4个参数到提示词：
  - chapter_text
  - old_state
  - character_dynamics（新增）
  - context_summary（新增）
- [ ] ⚠️ 增加 `try-except` 捕获 `KeyError`，处理旧模板缺少占位符的情况

### Step 4：更新提示词（升降级逻辑）
- [ ] 修改 `custom_prompts/update_character_state_prompt.txt`
- [ ] 同步修改 `core/prompting/prompt_definitions.py:790-898`
- [ ] 增加参数占位符 `{character_dynamics}` 和 `{context_summary}`
- [ ] 完善升降级策略（S/A/B三级体系）
- [ ] 补充死亡角色处理规范
- [ ] ⚠️ 提示用户：如有自定义模板，需手动更新或删除以使用新版

### Step 5：测试验证
- [ ] **测试1**：非分卷模式（30章）
  - 验证核心角色不遗漏
  - 验证临时角色正常删除

- [ ] **测试2**：分卷模式（70章分3卷）
  - 第一卷：验证仅传递global_summary
  - 第二卷：验证传递volume_1_summary + global_summary
  - 第三卷：验证传递volume_2_summary + global_summary

- [ ] **测试3**：角色生命周期
  - 核心角色死亡：保留完整状态，标记【已死亡】
  - 非核心角色死亡：降级后删除
  - 临时角色淡出：直接删除

---

## ⚠️ 注意事项与风险

### 1. 兼容性问题
**风险**：旧项目没有 `character_dynamics.txt` 文件

**应对**：
- 工具函数中增加容错：文件不存在则返回空字符串
- 提示词中说明：若角色框架缺失，仅基于当前状态更新
- GUI提示：检测到旧项目时提示"角色框架缺失，建议重新生成架构"

### 2. 提示词token消耗增加
**风险**：传递角色框架+摘要，token增加约1000-2000

**应对**：
- 仅传递必要信息（角色框架不包含世界观、剧情）
- 摘要已经在传递，只是增加了分卷逻辑
- 实际增量：约500-1000 token（可接受）

### 3. 降级判断准确性
**风险**：LLM可能误判角色重要性，错误降级

**应对**：
- 核心角色永不降级（S级保护）
- 非核心角色降级时有明确标准（基于摘要不再提及）
- 用户可手动编辑角色状态（UI已支持）

### 4. 分卷模式复杂度
**风险**：跨卷摘要传递逻辑复杂，可能出错

**应对**：
- 工具函数中增加详细日志
- 明确区分首卷/后续卷逻辑
- 容错处理：上一卷摘要缺失时填充"（上一卷摘要缺失）"
- ⚠️ **参数校验**：`total_chapters <= 0` 时回退为仅使用 global_summary

### 5. 提示词占位符兼容问题（新增）
**风险**：旧的自定义模板缺少 `{character_dynamics}` 和 `{context_summary}` 占位符，会抛出 `KeyError`

**应对**：
- **代码层**：在 `finalization.py` 中使用 `try-except` 捕获 `KeyError`，回退到默认模板
- **检测提示**：检测到旧模板时，在GUI日志中提示用户更新
- **文档说明**：在实施步骤和用户文档中明确提醒迁移自定义模板
- **降级方案**：若用户不愿更新，可临时使用默认模板（丧失自定义能力）

### 6. logging模块导入缺失（新增）
**风险**：`file_utils.py` 当前未导入 `logging`，新增函数中使用会导致 `NameError`

**应对**：
- **Step 2 实施时**：在 `file_utils.py` 顶部添加 `import logging`
- **验证方式**：运行测试前检查导入是否正确
- **备选方案**：若有冲突，可使用 `print()` 替代 `logging`（不推荐）

---

## 📝 修改文件清单

### 1. 新增文件
- 无（所有修改在现有文件中）

### 2. 修改文件
| 文件路径 | 修改内容 | 修改行数估计 |
|---------|---------|------------|
| `novel_generator/architecture.py` | 增加独立保存 character_dynamics.txt | +5行 |
| `core/utils/file_utils.py` | ⚠️ 顶部添加 `import logging` + 新增2个工具函数 | +65行 |
| `novel_generator/finalization.py` | 修改参数传递逻辑 + 增加异常处理 | +30行 |
| `custom_prompts/update_character_state_prompt.txt` | 重写提示词（增加占位符） | 完全替换 |
| `core/prompting/prompt_definitions.py` | 同步提示词常量（增加占位符） | 完全替换 |

### 3. 涉及模块
- 架构生成（architecture.py）
- 定稿流程（finalization.py）
- 工具函数（file_utils.py）
- 提示词系统（prompt_definitions.py + custom_prompts/）

---

## 📈 后续扩展方向

### 短期（1-2个月）
1. **角色关系网可视化**：基于角色状态生成关系图谱
2. **角色编辑器增强**：GUI支持手动升降级、删除角色
3. **角色导入导出**：支持从其他项目导入角色模板

### 中期（3-6个月）
1. **角色弧光追踪**：自动记录角色在各章节的成长轨迹
2. **动机冲突检测**：自动检测角色行为与动机的矛盾
3. **角色相似度分析**：检测角色同质化问题

### 长期（6个月+）
1. **多线程角色管理**：支持主线/支线不同角色集
2. **角色AI助手**：基于角色设定生成对话建议
3. **跨项目角色库**：建立全局角色模板库

---

## 📌 总结

本优化方案通过以下三个核心改进，彻底解决角色状态管理问题：

1. **独立保存角色框架**：避免正则提取的不可靠性，解耦架构文件
2. **增强参数传递**：传入角色框架+上下文摘要，提升LLM判断能力
3. **智能升降级机制**：基于摘要综合判断，S/A/B三级管理，规范死亡处理

**预期收益**：
- ✅ 核心角色遗漏率：30-40% → **0%**
- ✅ 角色状态完整性：60% → **95%+**
- ✅ 状态文档精简度：**+30-50%**
- ✅ 分卷一致性：70% → **95%+**

**实施成本**：
- 代码修改：约5个文件，+90行代码
- 测试时间：约2-3个测试项目
- 用户影响：旧项目需提示"角色框架缺失"，新项目自动支持

**风险可控**：
- 兼容性：容错处理，旧项目降级使用
- token消耗：增量可接受（+500-1000 token）
- 判断准确性：核心角色永不降级，误判风险低

---

**文档版本**：v1.0
**创建日期**：2025-10-04
**状态**：待审批实施
